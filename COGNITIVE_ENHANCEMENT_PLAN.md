# –ü–ª–∞–Ω –ö–æ–≥–Ω–∏—Ç–∏–≤–Ω–æ–≥–æ –£–ª—É—á—à–µ–Ω–∏—è Nano Bot V-2.0

**–ê–≤—Ç–æ—Ä**: Manus (–°—Ç—Ä–∞—Ç–µ–≥ –∏ –ê—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä)
**–î–∞—Ç–∞**: 15.02.2026
**–í–µ—Ä—Å–∏—è**: 1.0
**–°—Ç–∞—Ç—É—Å**: –û–∂–∏–¥–∞–µ—Ç –æ–¥–æ–±—Ä–µ–Ω–∏—è –ì.–í–∞–≥—É—Å–∞

---

## –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ

1. [–í–≤–µ–¥–µ–Ω–∏–µ](#–≤–≤–µ–¥–µ–Ω–∏–µ)
2. [–°–≤–æ–¥–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ —ç—Ç–∞–ø–æ–≤ –∏ –ø–æ–¥—ç—Ç–∞–ø–æ–≤](#—Å–≤–æ–¥–Ω–∞—è-—Ç–∞–±–ª–∏—Ü–∞)
3. [–≠—Ç–∞–ø 1: –†–µ—Ñ–ª–µ–∫—Å–∏—è](#—ç—Ç–∞–ø-1-—Ä–µ—Ñ–ª–µ–∫—Å–∏—è)
4. [–≠—Ç–∞–ø 2: –ò–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–∞—è –ü–∞–º—è—Ç—å](#—ç—Ç–∞–ø-2-–∏–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–∞—è-–ø–∞–º—è—Ç—å-h-mem)
5. [–≠—Ç–∞–ø 3: –ê–≤—Ç–æ–Ω–æ–º–∏—è –∏ –°–∞–º–æ–æ–±—É—á–µ–Ω–∏–µ](#—ç—Ç–∞–ø-3-–∞–≤—Ç–æ–Ω–æ–º–∏—è-–∏-—Å–∞–º–æ–æ–±—É—á–µ–Ω–∏–µ)
6. [–≠—Ç–∞–ø 4: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –£–ª—É—á—à–µ–Ω–∏—è](#—ç—Ç–∞–ø-4-–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ-—É–ª—É—á—à–µ–Ω–∏—è-–∏-–∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ)
7. [–ü–æ—Ä—è–¥–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏](#–ø–æ—Ä—è–¥–æ–∫-–≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è-–∏-–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏)

---

## –í–≤–µ–¥–µ–Ω–∏–µ

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π –¥–µ—Ç–∞–ª—å–Ω—É—é —Ç–µ—Ö–Ω–∏—á–µ—Å–∫—É—é –¥–æ—Ä–æ–∂–Ω—É—é –∫–∞—Ä—Ç—É –ø–æ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏ **Nano Bot V-2.0** –∏–∑ —Ä–µ–∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è –∫–æ–º–∞–Ω–¥ –≤ –∞–≤—Ç–æ–Ω–æ–º–Ω–æ–≥–æ, —Å–∞–º–æ–æ–±—É—á–∞—é—â–µ–≥–æ—Å—è –∏ —Ä–µ—Ñ–ª–µ–∫—Å–∏—Ä—É—é—â–µ–≥–æ –∫–æ–≥–Ω–∏—Ç–∏–≤–Ω–æ–≥–æ –∞–≥–µ–Ω—Ç–∞. –ü–ª–∞–Ω –æ—Å–Ω–æ–≤–∞–Ω –Ω–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö –≥–ª—É–±–æ–∫–æ–≥–æ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä –∫–æ–≥–Ω–∏—Ç–∏–≤–Ω—ã—Ö –∞–≥–µ–Ω—Ç–æ–≤ –∏ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω –ø–æ–¥ —Ç–µ–∫—É—â—É—é –∫–æ–¥–æ–≤—É—é –±–∞–∑—É –ø—Ä–æ–µ–∫—Ç–∞.

–ö–∞–∂–¥—ã–π —ç—Ç–∞–ø —Ä–∞–∑–±–∏—Ç –Ω–∞ –ø–æ–¥—ç—Ç–∞–ø—ã, –∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–¥—ç—Ç–∞–ø–∞ –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω **–≥–æ—Ç–æ–≤—ã–π –ø—Ä–æ–º—Ç –¥–ª—è Cursor** ‚Äî —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤—ã–≤–∞—Ç—å –∫–æ–¥. –ü—Ä–æ–º—Ç—ã –Ω–∞–ø–∏—Å–∞–Ω—ã —Å —É—á—ë—Ç–æ–º –∞–∫—Ç—É–∞–ª—å–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ñ–∞–π–ª–æ–≤, –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤ –∏ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞.

**–ü—Ä–∏–Ω—Ü–∏–ø—ã —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏:**

- –ö–∞–∂–¥—ã–π –ø–æ–¥—ç—Ç–∞–ø ‚Äî —ç—Ç–æ –∞—Ç–æ–º–∞—Ä–Ω–∞—è, —Ç–µ—Å—Ç–∏—Ä—É–µ–º–∞—è –µ–¥–∏–Ω–∏—Ü–∞ —Ä–∞–±–æ—Ç—ã.
- –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å: –Ω–æ–≤—ã–π –∫–æ–¥ –Ω–µ –¥–æ–ª–∂–µ–Ω –ª–æ–º–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å.
- –ü—Ä–æ–º—Ç—ã –¥–ª—è Cursor —Å–æ–¥–µ—Ä–∂–∞—Ç —Ç–æ—á–Ω—ã–µ –ø—É—Ç–∏ –∫ —Ñ–∞–π–ª–∞–º, –∏–º–µ–Ω–∞ –∫–ª–∞—Å—Å–æ–≤ –∏ —Å–∏–≥–Ω–∞—Ç—É—Ä—ã –º–µ—Ç–æ–¥–æ–≤.

---

## –°–≤–æ–¥–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞

| –≠—Ç–∞–ø | –ü–æ–¥—ç—Ç–∞–ø | –ù–∞–∑–≤–∞–Ω–∏–µ | –§–∞–π–ª—ã | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç |
|------|---------|----------|-------|-----------|
| 1 | 1.1 | –ú–æ–¥—É–ª—å –†–µ—Ñ–ª–µ–∫—Å–∏–∏ | `nanobot/agent/reflection.py` (–Ω–æ–≤—ã–π) | –í—ã—Å–æ–∫–∏–π |
| 1 | 1.2 | –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –†–µ—Ñ–ª–µ–∫—Å–∏–∏ –≤ AgentLoop | `nanobot/agent/loop.py` | –í—ã—Å–æ–∫–∏–π |
| 1 | 1.3 | –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ—Ñ–ª–µ–∫—Å–∏–π –≤ –ø–∞–º—è—Ç—å | `nanobot/agent/reflection.py`, `nanobot/memory/db.py` | –°—Ä–µ–¥–Ω–∏–π |
| 1 | 1.4 | –¢–µ—Å—Ç—ã –¥–ª—è –†–µ—Ñ–ª–µ–∫—Å–∏–∏ | `tests/test_reflection.py` (–Ω–æ–≤—ã–π) | –í—ã—Å–æ–∫–∏–π |
| 2 | 2.1 | –ú–∏–≥—Ä–∞—Ü–∏—è —Å—Ö–µ–º—ã –ë–î | `nanobot/memory/db.py`, `nanobot/memory/migrate.py` (–Ω–æ–≤—ã–π) | –í—ã—Å–æ–∫–∏–π |
| 2 | 2.2 | –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—Ä–∏—Å—Ç–∞–ª–ª–∏–∑–∞—Ü–∏–∏ | `nanobot/memory/crystallize.py` | –í—ã—Å–æ–∫–∏–π |
| 2 | 2.3 | –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç `memory_search` | `nanobot/agent/tools/memory.py` (–Ω–æ–≤—ã–π), `nanobot/agent/loop.py` | –í—ã—Å–æ–∫–∏–π |
| 2 | 2.4 | –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ | `nanobot/agent/context.py` | –°—Ä–µ–¥–Ω–∏–π |
| 2 | 2.5 | –¢–µ—Å—Ç—ã –¥–ª—è H-MEM | `tests/test_hmem.py` (–Ω–æ–≤—ã–π) | –í—ã—Å–æ–∫–∏–π |
| 3 | 3.1 | –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –Ω–∞–≤—ã–∫–æ–≤ | `nanobot/agent/skill_generator.py` (–Ω–æ–≤—ã–π) | –°—Ä–µ–¥–Ω–∏–π |
| 3 | 3.2 | –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç `create_skill` | `nanobot/agent/tools/skill.py` (–Ω–æ–≤—ã–π), `nanobot/agent/loop.py` | –°—Ä–µ–¥–Ω–∏–π |
| 3 | 3.3 | –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –Ω–∞–≤—ã–∫–æ–≤ | `nanobot/agent/loop.py` | –ù–∏–∑–∫–∏–π |
| 3 | 3.4 | –¢–µ—Å—Ç—ã –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –Ω–∞–≤—ã–∫–æ–≤ | `tests/test_skill_generator.py` (–Ω–æ–≤—ã–π) | –°—Ä–µ–¥–Ω–∏–π |
| 4 | 4.1 | –ú–µ—Ö–∞–Ω–∏–∑–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è (ToolPolicy FSM) | `nanobot/agent/tools/base.py`, `nanobot/agent/tools/registry.py`, `nanobot/session/manager.py`, `nanobot/agent/loop.py` | –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π |
| 4 | 4.2 | –£–ª—É—á—à–µ–Ω–∏–µ Heartbeat | `nanobot/heartbeat/service.py` | –°—Ä–µ–¥–Ω–∏–π |
| 4 | 4.3 | –ú–µ—Ç—Ä–∏–∫–∏ –∏ –Ω–∞–±–ª—é–¥–∞–µ–º–æ—Å—Ç—å | `nanobot/agent/metrics.py` (–Ω–æ–≤—ã–π) | –ù–∏–∑–∫–∏–π |

---

## –≠—Ç–∞–ø 1: –†–µ—Ñ–ª–µ–∫—Å–∏—è

**–¶–µ–ª—å**: –ù–∞—É—á–∏—Ç—å –∞–≥–µ–Ω—Ç–∞ –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–≤–æ–∏ –æ—à–∏–±–∫–∏ (–Ω–µ—É–¥–∞—á–Ω—ã–µ –≤—ã–∑–æ–≤—ã –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤), –ø–æ–Ω–∏–º–∞—Ç—å –∏—Ö –ø—Ä–∏—á–∏–Ω—É –∏ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–≤–æ—ë –ø–æ–≤–µ–¥–µ–Ω–∏–µ. –≠—Ç–æ –æ—Å–Ω–æ–≤–∞ –¥–ª—è —Å–∞–º–æ—Å–æ–≤–µ—Ä—à–µ–Ω—Å—Ç–≤–æ–≤–∞–Ω–∏—è ‚Äî —Ü–∏–∫–ª ¬´–†–µ—à–µ–Ω–∏–µ ‚Üí –ê–Ω–∞–ª–∏–∑ ‚Üí –ö–æ—Ä—Ä–µ–∫—Ü–∏—è¬ª.

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è –∏–¥–µ—è**: –ö–æ–≥–¥–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫—É, –≤–º–µ—Å—Ç–æ —Ç–æ–≥–æ —á—Ç–æ–±—ã —Å–ª–µ–ø–æ –ø–µ—Ä–µ–¥–∞—Ç—å –µ—ë LLM –∏ –Ω–∞–¥–µ—è—Ç—å—Å—è –Ω–∞ –ª—É—á—à–µ–µ, –º—ã –∑–∞–ø—É—Å–∫–∞–µ–º –æ—Ç–¥–µ–ª—å–Ω—ã–π, –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π LLM-–≤—ã–∑–æ–≤, –∫–æ—Ç–æ—Ä—ã–π –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –≤—Å—é —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏—é (–∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π + –Ω–µ—É–¥–∞–≤—à–∏–π—Å—è –≤—ã–∑–æ–≤ + –æ—à–∏–±–∫—É) –∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫—Ä–∞—Ç–∫–∏–π, –¥–µ–π—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—ã–≤–æ–¥. –≠—Ç–æ—Ç –≤—ã–≤–æ–¥ –∏–Ω—ä–µ—Ü–∏—Ä—É–µ—Ç—Å—è –æ–±—Ä–∞—Ç–Ω–æ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∞–≥–µ–Ω—Ç–∞, –Ω–∞–ø—Ä–∞–≤–ª—è—è –µ–≥–æ –∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º—É —Ä–µ—à–µ–Ω–∏—é.

---

### –ü–æ–¥—ç—Ç–∞–ø 1.1: –°–æ–∑–¥–∞–Ω–∏–µ –ú–æ–¥—É–ª—è –†–µ—Ñ–ª–µ–∫—Å–∏–∏

**–ß—Ç–æ –¥–µ–ª–∞–µ–º**: –°–æ–∑–¥–∞—ë–º –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –º–æ–¥—É–ª—å, –æ—Ç–≤–µ—á–∞—é—â–∏–π –∑–∞ –∞–Ω–∞–ª–∏–∑ –æ—à–∏–±–æ–∫ –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É—é—â–∏—Ö –≤—ã–≤–æ–¥–æ–≤.

**–ü—Ä–æ–º–ø—Ç –¥–ª—è Cursor ‚Ññ1:**

```
–ó–∞–¥–∞—á–∞: –°–æ–∑–¥–∞—Ç—å –º–æ–¥—É–ª—å Reflection

–°–æ–∑–¥–∞–π –Ω–æ–≤—ã–π —Ñ–∞–π–ª nanobot/agent/reflection.py —Å–æ —Å–ª–µ–¥—É—é—â–∏–º —Å–æ–¥–µ—Ä–∂–∏–º—ã–º.

–ö–ª–∞—Å—Å Reflection –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –∞–Ω–∞–ª–∏–∑ –Ω–µ—É–¥–∞—á–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤. –û–Ω –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –æ—Ç–¥–µ–ª—å–Ω—ã–π LLM-–≤—ã–∑–æ–≤ (—á–µ—Ä–µ–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π LLMProvider) –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫—Ä–∞—Ç–∫–æ–≥–æ –≤—ã–≤–æ–¥–∞ –æ –ø—Ä–∏—á–∏–Ω–µ –æ—à–∏–±–∫–∏ –∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é.

–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:

1. –§–∞–π–ª: nanobot/agent/reflection.py

2. –ò–º–ø–æ—Ä—Ç—ã: 
   - json, from typing import Any
   - from loguru import logger
   - from nanobot.providers.base import LLMProvider

3. –ö–æ–Ω—Å—Ç–∞–Ω—Ç–∞ REFLECTION_SYSTEM_PROMPT ‚Äî —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º—Ç –¥–ª—è LLM-—Ä–µ—Ñ–ª–µ–∫—Å–∏–∏:

REFLECTION_SYSTEM_PROMPT = """You are a Self-Correction module for an AI agent called nanobot.
Your task: analyze a failed tool call and provide a concise, actionable insight.

Rules:
1. Identify the ROOT CAUSE: wrong parameter? wrong assumption? wrong tool? missing prerequisite step?
2. Propose a SPECIFIC fix: suggest a corrected tool call or an alternative approach.
3. Be CONCISE: one paragraph, starting with "Reflection: ...".
4. Do NOT repeat the error message. Focus on the solution.

Example:
Reflection: The read_file tool failed because the path "config.yaml" is relative. The workspace is at C:/Users/kopca/Nano_Bot_V2/workspace/, so the correct path should be "C:/Users/kopca/Nano_Bot_V2/workspace/config.yaml". I should use list_dir first to verify the file exists."""

4. –ö–ª–∞—Å—Å Reflection:
   - __init__(self, provider: LLMProvider, model: str): —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç provider –∏ model.
   - async def analyze_trajectory(self, messages: list[dict[str, Any]], failed_tool_call: dict[str, Any], error_result: str) -> str | None:
     a. –§–æ—Ä–º–∏—Ä—É–µ—Ç user-–ø—Ä–æ–º—Ç —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 5 —Å–æ–æ–±—â–µ–Ω–∏—è—Ö –∏–∑ messages (—á—Ç–æ–±—ã –Ω–µ —Ä–∞–∑–¥—É–≤–∞—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç), –∏–º–µ–Ω–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞, –µ–≥–æ –∞—Ä–≥—É–º–µ–Ω—Ç–∞—Ö –∏ —Ç–µ–∫—Å—Ç–µ –æ—à–∏–±–∫–∏.
     b. –í—ã–∑—ã–≤–∞–µ—Ç self.provider.chat() —Å REFLECTION_SYSTEM_PROMPT –∏ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–º user-–ø—Ä–æ–º—Ç–æ–º.
     c. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç temperature=0.3 –∏ max_tokens=500 –¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏.
     d. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç response.content –∏–ª–∏ None –ø—Ä–∏ –æ—à–∏–±–∫–µ.
     e. –û–±–æ—Ä–∞—á–∏–≤–∞–µ—Ç –≤–µ—Å—å –≤—ã–∑–æ–≤ –≤ try/except, –ª–æ–≥–∏—Ä—É–µ—Ç –æ—à–∏–±–∫–∏ —á–µ—Ä–µ–∑ logger.warning.

5. –ú–µ—Ç–æ–¥ _format_user_prompt(self, messages, failed_tool_call, error_result) -> str:
   - –ë–µ—Ä—ë—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ messages –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –∏—Ö –≤ —á–∏—Ç–∞–µ–º—ã–π —Ç–µ–∫—Å—Ç.
   - –î–æ–±–∞–≤–ª—è–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –Ω–µ—É–¥–∞–≤—à–µ–º—Å—è –≤—ã–∑–æ–≤–µ: tool name, arguments (JSON).
   - –î–æ–±–∞–≤–ª—è–µ—Ç —Ç–µ–∫—Å—Ç –æ—à–∏–±–∫–∏.
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Å—Ç—Ä–æ–∫—É.

–ù–µ –¥–æ–±–∞–≤–ª—è–π –Ω–∏–∫–∞–∫–∏—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ (tools) –≤ –≤—ã–∑–æ–≤ provider.chat() ‚Äî —Ä–µ—Ñ–ª–µ–∫—Å–∏—è –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —á–∏—Å—Ç–æ —Ç–µ–∫—Å—Ç–æ–≤–æ–π.
```

---

### –ü–æ–¥—ç—Ç–∞–ø 1.2: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –†–µ—Ñ–ª–µ–∫—Å–∏–∏ –≤ AgentLoop

**–ß—Ç–æ –¥–µ–ª–∞–µ–º**: –í—Å—Ç—Ä–∞–∏–≤–∞–µ–º –º–µ—Ö–∞–Ω–∏–∑–º —Ä–µ—Ñ–ª–µ–∫—Å–∏–∏ –≤ –≥–ª–∞–≤–Ω—ã–π —Ü–∏–∫–ª –∞–≥–µ–Ω—Ç–∞. –ü—Ä–∏ –æ—à–∏–±–∫–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∞–Ω–∞–ª–∏–∑, –∏ –µ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏ LLM.

**–ü—Ä–æ–º–ø—Ç –¥–ª—è Cursor ‚Ññ2:**

```
–ó–∞–¥–∞—á–∞: –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å Reflection –≤ AgentLoop

–û—Ç–∫—Ä–æ–π —Ñ–∞–π–ª nanobot/agent/loop.py –∏ –≤–Ω–µ—Å–∏ —Å–ª–µ–¥—É—é—â–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è.

1. –î–æ–±–∞–≤—å –∏–º–ø–æ—Ä—Ç –≤ –Ω–∞—á–∞–ª–æ —Ñ–∞–π–ª–∞:
   from nanobot.agent.reflection import Reflection

2. –í –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–µ AgentLoop.__init__, –ø–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏ self.tools = ToolRegistry(), –¥–æ–±–∞–≤—å:
   self.reflection = Reflection(provider=provider, model=self.model)

3. –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É–π –º–µ—Ç–æ–¥ _process_message. –ù–∞–π–¥–∏ –±–ª–æ–∫:

   for tool_call in response.tool_calls:
       args_str = json.dumps(tool_call.arguments, ensure_ascii=False)
       logger.info(f"Tool call: {tool_call.name}({args_str[:200]})")
       result = await self.tools.execute(tool_call.name, tool_call.arguments)
       messages = self.context.add_tool_result(
           messages, tool_call.id, tool_call.name, result
       )

   –ó–∞–º–µ–Ω–∏ –µ–≥–æ –Ω–∞:

   for tool_call in response.tool_calls:
       args_str = json.dumps(tool_call.arguments, ensure_ascii=False)
       logger.info(f"Tool call: {tool_call.name}({args_str[:200]})")
       result = await self.tools.execute(tool_call.name, tool_call.arguments)
       
       # –†–µ—Ñ–ª–µ–∫—Å–∏—è –ø—Ä–∏ –æ—à–∏–±–∫–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
       if result.startswith("Error:"):
           logger.warning(f"Tool {tool_call.name} failed: {result[:200]}")
           try:
               failed_info = {
                   "name": tool_call.name,
                   "arguments": tool_call.arguments
               }
               insight = await self.reflection.analyze_trajectory(
                   messages=messages,
                   failed_tool_call=failed_info,
                   error_result=result
               )
               if insight:
                   logger.info(f"Reflection: {insight[:200]}")
           except Exception as e:
               logger.warning(f"Reflection failed: {e}")
       
       messages = self.context.add_tool_result(
           messages, tool_call.id, tool_call.name, result
       )

4. –°–¥–µ–ª–∞–π –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –≤ –º–µ—Ç–æ–¥–µ _process_system_message ‚Äî —Ç–∞–º –µ—Å—Ç—å —Ç–∞–∫–æ–π –∂–µ —Ü–∏–∫–ª –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤.

–í–∞–∂–Ω–æ: –ù–ï –¥–æ–±–∞–≤–ª—è–π insight –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω–æ–µ assistant-—Å–æ–æ–±—â–µ–Ω–∏–µ. LLM —É–∂–µ –ø–æ–ª—É—á–∏—Ç –æ—à–∏–±–∫—É —á–µ—Ä–µ–∑ tool_result. Insight –±—É–¥–µ—Ç –∑–∞–ª–æ–≥–∏—Ä–æ–≤–∞–Ω –∏ —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ –ø–∞–º—è—Ç—å (—Å–ª–µ–¥—É—é—â–∏–π –ø–æ–¥—ç—Ç–∞–ø). LLM —Å–∞–º —É–≤–∏–¥–∏—Ç –æ—à–∏–±–∫—É –∏ —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ—Ç –ø–æ–≤–µ–¥–µ–Ω–∏–µ, –∞ insight –ø–æ–º–æ–∂–µ—Ç –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –ª–æ–≥–æ–≤.
```

---

### –ü–æ–¥—ç—Ç–∞–ø 1.3: –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –†–µ—Ñ–ª–µ–∫—Å–∏–π –≤ –ü–∞–º—è—Ç—å

**–ß—Ç–æ –¥–µ–ª–∞–µ–º**: –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å–µ —Ä–µ—Ñ–ª–µ–∫—Å–∏–∏ –≤ SQLite –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –∏ –æ–±—É—á–µ–Ω–∏—è. –≠—Ç–æ —Å–æ–∑–¥–∞—ë—Ç ¬´–∂—É—Ä–Ω–∞–ª –æ—à–∏–±–æ–∫¬ª, –∫–æ—Ç–æ—Ä—ã–π –∞–≥–µ–Ω—Ç –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –æ—à–∏–±–æ–∫.

**–ü—Ä–æ–º–ø—Ç –¥–ª—è Cursor ‚Ññ3:**

```
–ó–∞–¥–∞—á–∞: –°–æ—Ö—Ä–∞–Ω—è—Ç—å —Ä–µ—Ñ–ª–µ–∫—Å–∏–∏ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö

1. –û—Ç–∫—Ä–æ–π nanobot/memory/db.py.

2. –î–æ–±–∞–≤—å –Ω–æ–≤—É—é —Ç–∞–±–ª–∏—Ü—É reflections –≤ —Ñ—É–Ω–∫—Ü–∏—é init_db():

   conn.execute(
       """
       CREATE TABLE IF NOT EXISTS reflections (
           id INTEGER PRIMARY KEY AUTOINCREMENT,
           tool_name TEXT NOT NULL,
           tool_args TEXT,
           error_text TEXT NOT NULL,
           insight TEXT NOT NULL,
           session_key TEXT,
           created_at TEXT NOT NULL
       )
       """
   )
   conn.execute(
       "CREATE INDEX IF NOT EXISTS idx_reflections_tool ON reflections(tool_name)"
   )

3. –î–æ–±–∞–≤—å —Ñ—É–Ω–∫—Ü–∏—é add_reflection():

   def add_reflection(
       tool_name: str,
       tool_args: str,
       error_text: str,
       insight: str,
       session_key: str | None = None,
   ) -> None:
       """–°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ä–µ—Ñ–ª–µ–∫—Å–∏—é –æ–± –æ—à–∏–±–∫–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞."""
       init_db()
       with _connect() as conn:
           conn.execute(
               """
               INSERT INTO reflections (tool_name, tool_args, error_text, insight, session_key, created_at)
               VALUES (?, ?, ?, ?, ?, ?)
               """,
               (tool_name, tool_args, error_text, insight, session_key, _now_iso()),
           )
           conn.commit()

4. –î–æ–±–∞–≤—å —Ñ—É–Ω–∫—Ü–∏—é get_recent_reflections():

   def get_recent_reflections(tool_name: str | None = None, limit: int = 10) -> list[dict[str, Any]]:
       """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Ä–µ—Ñ–ª–µ–∫—Å–∏–∏, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ —Ñ–∏–ª—å—Ç—Ä—É—è –ø–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—É."""
       init_db()
       if tool_name:
           query = "SELECT * FROM reflections WHERE tool_name = ? ORDER BY id DESC LIMIT ?"
           params = (tool_name, limit)
       else:
           query = "SELECT * FROM reflections ORDER BY id DESC LIMIT ?"
           params = (limit,)
       with _connect() as conn:
           rows = conn.execute(query, params).fetchall()
       return [_row_to_dict(row) for row in rows]

5. –û—Ç–∫—Ä–æ–π nanobot/agent/loop.py.

6. –î–æ–±–∞–≤—å –∏–º–ø–æ—Ä—Ç: from nanobot.memory.db import add_reflection

7. –í _process_message, –ø–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏ logger.info(f"Reflection: {insight[:200]}"), –¥–æ–±–∞–≤—å:
   
   add_reflection(
       tool_name=tool_call.name,
       tool_args=args_str[:500],
       error_text=result[:500],
       insight=insight[:1000],
       session_key=msg.session_key,
   )
```

---

### –ü–æ–¥—ç—Ç–∞–ø 1.4: –¢–µ—Å—Ç—ã –¥–ª—è –ú–æ–¥—É–ª—è –†–µ—Ñ–ª–µ–∫—Å–∏–∏

**–ß—Ç–æ –¥–µ–ª–∞–µ–º**: –°–æ–∑–¥–∞—ë–º unit-—Ç–µ—Å—Ç—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ –º–æ–¥—É–ª—è —Ä–µ—Ñ–ª–µ–∫—Å–∏–∏.

**–ü—Ä–æ–º–ø—Ç –¥–ª—è Cursor ‚Ññ4:**

```
–ó–∞–¥–∞—á–∞: –ù–∞–ø–∏—Å–∞—Ç—å —Ç–µ—Å—Ç—ã –¥–ª—è –º–æ–¥—É–ª—è Reflection

–°–æ–∑–¥–∞–π —Ñ–∞–π–ª tests/test_reflection.py.

–¢–µ—Å—Ç—ã –¥–æ–ª–∂–Ω—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å pytest –∏ unittest.mock –¥–ª—è –º–æ–∫–∏—Ä–æ–≤–∞–Ω–∏—è LLMProvider.

1. test_analyze_trajectory_returns_insight:
   - –ú–æ–∫–∏—Ä—É–π LLMProvider.chat() —Ç–∞–∫, —á—Ç–æ–±—ã –æ–Ω –≤–æ–∑–≤—Ä–∞—â–∞–ª LLMResponse —Å content="Reflection: The file path was wrong."
   - –í—ã–∑–æ–≤–∏ reflection.analyze_trajectory() —Å —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏.
   - –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç "Reflection:".

2. test_analyze_trajectory_handles_llm_error:
   - –ú–æ–∫–∏—Ä—É–π LLMProvider.chat() —Ç–∞–∫, —á—Ç–æ–±—ã –æ–Ω –≤—ã–±—Ä–∞—Å—ã–≤–∞–ª Exception.
   - –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ analyze_trajectory() –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç None –∏ –Ω–µ –ø–∞–¥–∞–µ—Ç.

3. test_format_user_prompt_limits_history:
   - –ü–µ—Ä–µ–¥–∞–π messages —Å 20 —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏.
   - –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ _format_user_prompt –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5.

4. test_add_reflection_to_db:
   - –í—ã–∑–æ–≤–∏ add_reflection() —Å —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏.
   - –í—ã–∑–æ–≤–∏ get_recent_reflections() –∏ –ø—Ä–æ–≤–µ—Ä—å, —á—Ç–æ –∑–∞–ø–∏—Å—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞.

–ò—Å–ø–æ–ª—å–∑—É–π —Ñ–∏–∫—Å—Ç—É—Ä—É tmp_path –¥–ª—è –∏–∑–æ–ª—è—Ü–∏–∏ –ë–î (–ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏ DB_PATH —á–µ—Ä–µ–∑ monkeypatch).
```

---

## –≠—Ç–∞–ø 2: –ò–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–∞—è –ü–∞–º—è—Ç—å (H-MEM)

**–¶–µ–ª—å**: –†–µ—Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–∞–º—è—Ç—å –∞–≥–µ–Ω—Ç–∞, –ø–µ—Ä–µ–π–¥—è –æ—Ç –ø–ª–æ—Å–∫–æ–≥–æ —Å–ø–∏—Å–∫–∞ —Ñ–∞–∫—Ç–æ–≤ –∫ –∏–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ **Domain ‚Üí Category ‚Üí Sub-Category ‚Üí Key/Value**. –≠—Ç–æ –ø–æ–∑–≤–æ–ª–∏—Ç –±–æ–ª–µ–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É–∞–ª—å–Ω–æ –∏–∑–≤–ª–µ–∫–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, —É–ª—É—á—à–∞—è —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å –æ—Ç–≤–µ—Ç–æ–≤ –∏ —Å–Ω–∏–∂–∞—è ¬´–∑–∞—Å–æ—Ä–µ–Ω–∏–µ¬ª –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –Ω–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–º–∏ —Ñ–∞–∫—Ç–∞–º–∏.

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è –∏–¥–µ—è**: –í–º–µ—Å—Ç–æ —Ç–æ–≥–æ —á—Ç–æ–±—ã —Ö—Ä–∞–Ω–∏—Ç—å –≤—Å–µ —Ñ–∞–∫—Ç—ã –≤ –æ–¥–Ω–æ–π –ø–ª–æ—Å–∫–æ–π –∫–æ–ª–ª–µ–∫—Ü–∏–∏, –º—ã –¥–æ–±–∞–≤–ª—è–µ–º –¥–≤–∞ —É—Ä–æ–≤–Ω—è –∏–µ—Ä–∞—Ä—Ö–∏–∏: `domain` (—à–∏—Ä–æ–∫–∞—è –æ–±–ª–∞—Å—Ç—å, –Ω–∞–ø—Ä–∏–º–µ—Ä, ¬´–ü—Ä–æ–µ–∫—Ç: Nano Bot¬ª –∏–ª–∏ ¬´–ü—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è¬ª) –∏ `sub_category` (–¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –≤–Ω—É—Ç—Ä–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏). –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –∞–≥–µ–Ω—Ç—É –ø—Ä–∏ –ø–æ–∏—Å–∫–µ —Ñ–∞–∫—Ç–æ–≤ —Å—É–∂–∞—Ç—å –æ–±–ª–∞—Å—Ç—å –ø–æ–∏—Å–∫–∞, —á—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ –ø—Ä–∏ —Ä–æ—Å—Ç–µ –æ–±—ä—ë–º–∞ –ø–∞–º—è—Ç–∏.

---

### –ü–æ–¥—ç—Ç–∞–ø 2.1: –ú–∏–≥—Ä–∞—Ü–∏—è –°—Ö–µ–º—ã –ë–∞–∑—ã –î–∞–Ω–Ω—ã—Ö

**–ß—Ç–æ –¥–µ–ª–∞–µ–º**: –†–∞—Å—à–∏—Ä—è–µ–º —Ç–∞–±–ª–∏—Ü—É `facts` –Ω–æ–≤—ã–º–∏ –ø–æ–ª—è–º–∏ –∏ —Å–æ–∑–¥–∞—ë–º –º–µ—Ö–∞–Ω–∏–∑–º –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö.

**–ü—Ä–æ–º–ø—Ç –¥–ª—è Cursor ‚Ññ5:**

```
–ó–∞–¥–∞—á–∞: –û–±–Ω–æ–≤–∏—Ç—å —Å—Ö–µ–º—É –ë–î —Å –º–∏–≥—Ä–∞—Ü–∏–µ–π

1. –°–æ–∑–¥–∞–π –Ω–æ–≤—ã–π —Ñ–∞–π–ª nanobot/memory/migrate.py.

   –≠—Ç–æ—Ç —Ñ–∞–π–ª –±—É–¥–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏ –º–∏–≥—Ä–∞—Ü–∏–∏ –ë–î. –ù–∞–º –Ω—É–∂–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª–µ–π domain –∏ sub_category –≤ —Ç–∞–±–ª–∏—Ü—É facts.

   from pathlib import Path
   import sqlite3
   from loguru import logger
   from nanobot.memory.db import DB_PATH, _connect, init_db

   MIGRATIONS = [
       {
           "version": 1,
           "description": "Add domain and sub_category to facts",
           "sql": [
               "ALTER TABLE facts ADD COLUMN domain TEXT DEFAULT NULL",
               "ALTER TABLE facts ADD COLUMN sub_category TEXT DEFAULT NULL",
           ]
       },
   ]

   def get_db_version() -> int:
       """–ü–æ–ª—É—á–∞–µ—Ç —Ç–µ–∫—É—â—É—é –≤–µ—Ä—Å–∏—é —Å—Ö–µ–º—ã –ë–î."""
       try:
           with _connect() as conn:
               conn.execute("CREATE TABLE IF NOT EXISTS schema_version (version INTEGER NOT NULL)")
               row = conn.execute("SELECT MAX(version) FROM schema_version").fetchone()
               return row[0] if row and row[0] else 0
       except Exception:
           return 0

   def run_migrations() -> None:
       """–ü—Ä–∏–º–µ–Ω—è–µ—Ç –≤—Å–µ –Ω–µ–ø—Ä–∏–º–µ–Ω–µ–Ω–Ω—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏."""
       init_db()  # –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –±–∞–∑–æ–≤—ã–µ —Ç–∞–±–ª–∏—Ü—ã —Å—É—â–µ—Å—Ç–≤—É—é—Ç
       current = get_db_version()
       
       for migration in MIGRATIONS:
           if migration["version"] <= current:
               continue
           
           logger.info(f"Running migration v{migration['version']}: {migration['description']}")
           try:
               with _connect() as conn:
                   for sql in migration["sql"]:
                       try:
                           conn.execute(sql)
                       except sqlite3.OperationalError as e:
                           if "duplicate column" in str(e).lower():
                               logger.debug(f"Column already exists, skipping: {sql}")
                           else:
                               raise
                   conn.execute("INSERT INTO schema_version (version) VALUES (?)", (migration["version"],))
                   conn.commit()
               logger.info(f"Migration v{migration['version']} completed")
           except Exception as e:
               logger.error(f"Migration v{migration['version']} failed: {e}")
               raise

2. –û—Ç–∫—Ä–æ–π nanobot/memory/db.py.

3. –û–±–Ω–æ–≤–∏ —Ñ—É–Ω–∫—Ü–∏—é add_fact ‚Äî –¥–æ–±–∞–≤—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã domain –∏ sub_category:

   def add_fact(category: str, key: str, value: str, domain: str | None = None, sub_category: str | None = None) -> None:
       """–î–æ–±–∞–≤–ª—è–µ—Ç —Ñ–∞–∫—Ç –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ."""
       init_db()
       now = _now_iso()
       with _connect() as conn:
           conn.execute(
               """
               INSERT INTO facts (domain, category, sub_category, key, value, created_at, updated_at)
               VALUES (?, ?, ?, ?, ?, ?, ?)
               ON CONFLICT(category, key)
               DO UPDATE SET
                   value = excluded.value,
                   domain = COALESCE(excluded.domain, domain),
                   sub_category = COALESCE(excluded.sub_category, sub_category),
                   updated_at = excluded.updated_at
               """,
               (domain, category, sub_category, key, value, now, now),
           )
           conn.commit()
       
       # –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –≤ ChromaDB
       try:
           vid = _fact_vector_id(category, key)
           text = f"Domain: {domain or 'general'}\nCategory: {category}\nKey: {key}\nValue: {value}"
           add_vector_memory(
               memory_id=vid,
               text=text,
               metadata={
                   "type": "fact",
                   "domain": domain or "general",
                   "category": category,
                   "sub_category": sub_category or "",
                   "key": key,
                   "value": value,
                   "updated_at": now,
               },
           )
       except Exception as exc:
           logger.debug("Failed to sync fact into vector DB: %s", exc)

4. –î–æ–±–∞–≤—å –Ω–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø–æ–∏—Å–∫–∞:

   def get_facts_by_domain(domain: str) -> list[dict[str, Any]]:
       """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤—Å–µ —Ñ–∞–∫—Ç—ã —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –¥–æ–º–µ–Ω–∞."""
       init_db()
       with _connect() as conn:
           rows = conn.execute(
               "SELECT * FROM facts WHERE domain = ? ORDER BY category, key",
               (domain,),
           ).fetchall()
       return [_row_to_dict(row) for row in rows]

   def get_facts_filtered(domain: str | None = None, category: str | None = None) -> list[dict[str, Any]]:
       """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ñ–∞–∫—Ç—ã —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –ø–æ domain –∏/–∏–ª–∏ category."""
       init_db()
       conditions = []
       params = []
       if domain:
           conditions.append("domain = ?")
           params.append(domain)
       if category:
           conditions.append("category = ?")
           params.append(category)
       
       where = " AND ".join(conditions) if conditions else "1=1"
       with _connect() as conn:
           rows = conn.execute(
               f"SELECT * FROM facts WHERE {where} ORDER BY domain, category, key",
               params,
           ).fetchall()
       return [_row_to_dict(row) for row in rows]

5. –û—Ç–∫—Ä–æ–π nanobot/__main__.py (–∏–ª–∏ –º–µ—Å—Ç–æ, –≥–¥–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è).
   –î–æ–±–∞–≤—å –≤—ã–∑–æ–≤ run_migrations() –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ:
   
   from nanobot.memory.migrate import run_migrations
   run_migrations()

–í–∞–∂–Ω–æ: –ù–ï –º–µ–Ω—è–π UNIQUE constraint –≤ CREATE TABLE, —Ç–∞–∫ –∫–∞–∫ —ç—Ç–æ —Å–ª–æ–º–∞–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ë–î. –ú–∏–≥—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ ALTER TABLE ADD COLUMN –±–µ–∑–æ–ø–∞—Å–Ω–∞ –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö.
```

---

### –ü–æ–¥—ç—Ç–∞–ø 2.2: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ü—Ä–æ—Ü–µ—Å—Å–∞ –ö—Ä–∏—Å—Ç–∞–ª–ª–∏–∑–∞—Ü–∏–∏

**–ß—Ç–æ –¥–µ–ª–∞–µ–º**: –£—á–∏–º LLM –∏–∑–≤–ª–µ–∫–∞—Ç—å —Ñ–∞–∫—Ç—ã –≤ –Ω–æ–≤–æ–π –∏–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ —Å –ø–æ–ª—è–º–∏ `domain` –∏ `sub_category`.

**–ü—Ä–æ–º–ø—Ç –¥–ª—è Cursor ‚Ññ6:**

```
–ó–∞–¥–∞—á–∞: –ê–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å –∫—Ä–∏—Å—Ç–∞–ª–ª–∏–∑–∞—Ü–∏—é –ø–æ–¥ –∏–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫—É—é –ø–∞–º—è—Ç—å

–û—Ç–∫—Ä–æ–π —Ñ–∞–π–ª nanobot/memory/crystallize.py.

1. –ó–∞–º–µ–Ω–∏ CRYSTALLIZE_PROMPT –Ω–∞ –Ω–æ–≤—ã–π:

CRYSTALLIZE_PROMPT = """Analyze the following dialogues. Extract key facts and user preferences, structuring them hierarchically.

Return a JSON array with this structure:
[{"domain": "...", "category": "...", "sub_category": "...", "key": "...", "value": "..."}]

**Hierarchy Guidelines:**
- domain: Broad area or project (e.g., "User Preferences", "Project: Nano Bot", "Technology: Python", "Work", "Personal").
- category: Specific topic within the domain (e.g., "Architecture", "Hobbies", "Libraries", "Communication").
- sub_category: Optional further detail (e.g., "Database", "Music Genres"). Set to null if not applicable.
- key: The specific attribute name.
- value: The attribute value.

**Requirements:**
- Return ONLY the JSON array (no markdown, no explanations).
- Be specific and concise in key/value pairs.
- Avoid duplicates.
- If no facts found, return [].

**Example:**
[
  {"domain": "User Preferences", "category": "Communication", "sub_category": null, "key": "Preferred Language", "value": "Russian"},
  {"domain": "Project: Nano Bot", "category": "Architecture", "sub_category": "Memory", "key": "Vector DB Engine", "value": "ChromaDB"},
  {"domain": "Personal", "category": "Schedule", "sub_category": null, "key": "Work Hours", "value": "9:00-18:00"}
]"""

2. –û–±–Ω–æ–≤–∏ —Ñ—É–Ω–∫—Ü–∏—é _normalize_facts:
   - –ò–∑–≤–ª–µ–∫–∞–π domain –∏ sub_category –∏–∑ –∫–∞–∂–¥–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞.
   - –ö–ª—é—á –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏: (domain, category, key) –≤–º–µ—Å—Ç–æ (category, key, value).
   
   def _normalize_facts(raw_facts: list[dict[str, Any]]) -> list[dict[str, str]]:
       normalized: list[dict[str, str]] = []
       seen: set[tuple[str, str, str]] = set()
       for item in raw_facts:
           domain = str(item.get("domain", "")).strip() or "general"
           category = str(item.get("category", "")).strip()
           sub_category = str(item.get("sub_category") or "").strip() or None
           key = str(item.get("key", "")).strip()
           value = str(item.get("value", "")).strip()
           if not category or not key or not value:
               continue
           identity = (domain.lower(), category.lower(), key.lower())
           if identity in seen:
               continue
           seen.add(identity)
           fact = {"domain": domain, "category": category, "key": key, "value": value}
           if sub_category:
               fact["sub_category"] = sub_category
           normalized.append(fact)
       return normalized

3. –û–±–Ω–æ–≤–∏ –≤—ã–∑–æ–≤ add_fact –≤ crystallize_memories:

   for fact in facts:
       try:
           add_fact(
               category=fact["category"],
               key=fact["key"],
               value=fact["value"],
               domain=fact.get("domain"),
               sub_category=fact.get("sub_category"),
           )
           saved += 1
       except Exception as exc:
           logger.warning(f"Crystallize: failed to save fact {fact}: {exc}")
```

---

### –ü–æ–¥—ç—Ç–∞–ø 2.3: –°–æ–∑–¥–∞–Ω–∏–µ –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ `memory_search`

**–ß—Ç–æ –¥–µ–ª–∞–µ–º**: –î–∞—ë–º –∞–≥–µ–Ω—Ç—É –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Ü–µ–ª–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ –∏—Å–∫–∞—Ç—å —Ñ–∞–∫—Ç—ã –≤ —Å–≤–æ–µ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –ø–∞–º—è—Ç–∏ —á–µ—Ä–µ–∑ –Ω–æ–≤—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç.

**–ü—Ä–æ–º–ø—Ç –¥–ª—è Cursor ‚Ññ7:**

```
–ó–∞–¥–∞—á–∞: –°–æ–∑–¥–∞—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç MemorySearchTool

1. –°–æ–∑–¥–∞–π —Ñ–∞–π–ª nanobot/agent/tools/memory.py:

from typing import Any
from nanobot.agent.tools.base import Tool


class MemorySearchTool(Tool):
    """Tool for searching agent's hierarchical memory."""

    @property
    def name(self) -> str:
        return "memory_search"

    @property
    def description(self) -> str:
        return (
            "Search for facts in your memory. You can filter by domain, category, "
            "or perform a semantic search using a natural language query. "
            "Use this to recall user preferences, project details, or past decisions."
        )

    @property
    def parameters(self) -> dict[str, Any]:
        return {
            "type": "object",
            "properties": {
                "query": {
                    "type": "string",
                    "description": "Natural language query for semantic search across all facts."
                },
                "domain": {
                    "type": "string",
                    "description": "Filter by domain (e.g., 'User Preferences', 'Project: Nano Bot')."
                },
                "category": {
                    "type": "string",
                    "description": "Filter by category (e.g., 'Architecture', 'Hobbies')."
                },
                "limit": {
                    "type": "integer",
                    "description": "Maximum number of results to return (default 10)."
                }
            }
        }

    async def execute(self, query: str | None = None, domain: str | None = None, category: str | None = None, limit: int = 10, **kwargs) -> str:
        from nanobot.memory.db import semantic_search, get_facts_filtered, search_facts

        results = []

        # –°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫
        if query:
            try:
                hits = semantic_search(query, limit=limit)
                results.extend(hits)
            except Exception:
                # Fallback –Ω–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫
                hits = search_facts(query)
                results.extend(hits[:limit])

        # –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ domain/category
        if domain or category:
            filtered = get_facts_filtered(domain=domain, category=category)
            # –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ, –∫–æ—Ç–æ—Ä—ã—Ö –µ—â—ë –Ω–µ—Ç
            existing_keys = {(r.get("category", ""), r.get("key", "")) for r in results}
            for f in filtered[:limit]:
                if (f.get("category", ""), f.get("key", "")) not in existing_keys:
                    results.append(f)

        if not query and not domain and not category:
            return "Error: At least one parameter (query, domain, or category) must be provided."

        if not results:
            return "No facts found matching your search criteria."

        # –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        lines = [f"Found {len(results)} fact(s):\n"]
        for i, fact in enumerate(results[:limit], 1):
            d = fact.get("domain", "‚Äî")
            c = fact.get("category", "‚Äî")
            k = fact.get("key", "‚Äî")
            v = fact.get("value", "‚Äî")
            dist = fact.get("distance")
            line = f"{i}. [{d}] {c} ‚Üí {k}: {v}"
            if dist is not None:
                line += f" (relevance: {1 - dist:.2f})"
            lines.append(line)

        return "\n".join(lines)

2. –û—Ç–∫—Ä–æ–π nanobot/agent/loop.py.

3. –î–æ–±–∞–≤—å –∏–º–ø–æ—Ä—Ç:
   from nanobot.agent.tools.memory import MemorySearchTool

4. –í _register_default_tools, –ø–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ WebFetchTool, –¥–æ–±–∞–≤—å:
   self.tools.register(MemorySearchTool())
```

---

### –ü–æ–¥—ç—Ç–∞–ø 2.4: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –ö–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏–∑ –ü–∞–º—è—Ç–∏

**–ß—Ç–æ –¥–µ–ª–∞–µ–º**: –ü—Ä–∏ –∫–∞–∂–¥–æ–º –Ω–æ–≤–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—â–µ–º —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ —Ñ–∞–∫—Ç—ã –≤ –ø–∞–º—è—Ç–∏ –∏ –¥–æ–±–∞–≤–ª—è–µ–º –∏—Ö –≤ —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º—Ç. –≠—Ç–æ –¥–µ–ª–∞–µ—Ç –∞–≥–µ–Ω—Ç–∞ ¬´–æ—Å–≤–µ–¥–æ–º–ª—ë–Ω–Ω—ã–º¬ª –æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –±–µ–∑ —è–≤–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞.

**–ü—Ä–æ–º–ø—Ç –¥–ª—è Cursor ‚Ññ8:**

```
–ó–∞–¥–∞—á–∞: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–æ–≥–∞—â–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —Ñ–∞–∫—Ç–∞–º–∏ –∏–∑ –ø–∞–º—è—Ç–∏

–û—Ç–∫—Ä–æ–π —Ñ–∞–π–ª nanobot/agent/context.py.

1. –î–æ–±–∞–≤—å –∏–º–ø–æ—Ä—Ç –≤ –Ω–∞—á–∞–ª–æ —Ñ–∞–π–ª–∞:
   from nanobot.memory.db import semantic_search

2. –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É–π –º–µ—Ç–æ–¥ build_messages. –ü–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏:
   messages.append({"role": "system", "content": system_prompt})
   
   –î–æ–±–∞–≤—å –±–ª–æ–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö —Ñ–∞–∫—Ç–æ–≤:

   # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–æ–≥–∞—â–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏–∑ –ø–∞–º—è—Ç–∏
   if current_message and len(current_message) > 10:  # –ù–µ –∏—â–µ–º –¥–ª—è –∫–æ—Ä–æ—Ç–∫–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
       try:
           relevant_facts = semantic_search(current_message, limit=5)
           if relevant_facts:
               facts_text = "\n".join(
                   f"- [{f.get('domain', '?')}] {f.get('category', '?')} ‚Üí {f.get('key', '?')}: {f.get('value', '?')}"
                   for f in relevant_facts
                   if f.get("distance", 1.0) < 0.7  # –¢–æ–ª—å–∫–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ (cosine distance < 0.7)
               )
               if facts_text:
                   messages.append({
                       "role": "system",
                       "content": f"Relevant facts from your memory:\n{facts_text}"
                   })
       except Exception:
           pass  # –ù–µ –ª–æ–º–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –ø–æ—Ç–æ–∫ –ø—Ä–∏ –æ—à–∏–±–∫–µ –ø–∞–º—è—Ç–∏

–í–∞–∂–Ω–æ: 
- –§–∏–ª—å—Ç—Ä—É–π –ø–æ distance < 0.7 (cosine), —á—Ç–æ–±—ã –Ω–µ –∑–∞—Å–æ—Ä—è—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –Ω–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–º–∏ —Ñ–∞–∫—Ç–∞–º–∏.
- –û–±–æ—Ä–∞—á–∏–≤–∞–π –≤ try/except, —á—Ç–æ–±—ã –æ—à–∏–±–∫–∏ ChromaDB –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–∏ —Ä–∞–±–æ—Ç—É –∞–≥–µ–Ω—Ç–∞.
- –ù–µ –∏—â–∏ –¥–ª—è –∫–æ—Ä–æ—Ç–∫–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (–º–µ–Ω–µ–µ 10 —Å–∏–º–≤–æ–ª–æ–≤), —á—Ç–æ–±—ã –Ω–µ —Ç—Ä–∞—Ç–∏—Ç—å —Ä–µ—Å—É—Ä—Å—ã –Ω–∞ "–¥–∞", "–æ–∫" –∏ —Ç.–ø.
```

---

### –ü–æ–¥—ç—Ç–∞–ø 2.5: –¢–µ—Å—Ç—ã –¥–ª—è –ò–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–æ–π –ü–∞–º—è—Ç–∏

**–ß—Ç–æ –¥–µ–ª–∞–µ–º**: –°–æ–∑–¥–∞—ë–º —Ç–µ—Å—Ç—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –º–∏–≥—Ä–∞—Ü–∏–∏, –Ω–æ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π –ø–æ–∏—Å–∫–∞ –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ `memory_search`.

**–ü—Ä–æ–º–ø—Ç –¥–ª—è Cursor ‚Ññ9:**

```
–ó–∞–¥–∞—á–∞: –ù–∞–ø–∏—Å–∞—Ç—å —Ç–µ—Å—Ç—ã –¥–ª—è –∏–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–æ–π –ø–∞–º—è—Ç–∏

–°–æ–∑–¥–∞–π —Ñ–∞–π–ª tests/test_hmem.py.

1. test_migration_adds_columns:
   - –°–æ–∑–¥–∞–π —Ç–µ—Å—Ç–æ–≤—É—é –ë–î —Å init_db().
   - –ó–∞–ø—É—Å—Ç–∏ run_migrations().
   - –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ —Å—Ç–æ–ª–±—Ü—ã domain –∏ sub_category —Å—É—â–µ—Å—Ç–≤—É—é—Ç –≤ —Ç–∞–±–ª–∏—Ü–µ facts.

2. test_add_fact_with_domain:
   - –í—ã–∑–æ–≤–∏ add_fact(category="Arch", key="DB", value="SQLite", domain="Project: NanoBot", sub_category="Storage").
   - –í—ã–∑–æ–≤–∏ get_fact("Arch", "DB") –∏ –ø—Ä–æ–≤–µ—Ä—å, —á—Ç–æ –≤—Å–µ –ø–æ–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã.

3. test_get_facts_filtered:
   - –î–æ–±–∞–≤—å 5 —Ñ–∞–∫—Ç–æ–≤ —Å —Ä–∞–∑–Ω—ã–º–∏ domain –∏ category.
   - –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ get_facts_filtered(domain="X") –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Ñ–∞–∫—Ç—ã –¥–æ–º–µ–Ω–∞ X.
   - –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ get_facts_filtered(domain="X", category="Y") —Å—É–∂–∞–µ—Ç –≤—ã–±–æ—Ä–∫—É.

4. test_memory_search_tool_semantic:
   - –ú–æ–∫–∏—Ä—É–π semantic_search, —á—Ç–æ–±—ã –æ–Ω –≤–æ–∑–≤—Ä–∞—â–∞–ª —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ.
   - –í—ã–∑–æ–≤–∏ MemorySearchTool().execute(query="test").
   - –ü—Ä–æ–≤–µ—Ä—å —Ñ–æ—Ä–º–∞—Ç –≤—ã–≤–æ–¥–∞.

5. test_memory_search_tool_no_params:
   - –í—ã–∑–æ–≤–∏ MemorySearchTool().execute() –±–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤.
   - –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –æ—à–∏–±–∫–∞.

6. test_crystallize_with_hierarchy:
   - –ú–æ–∫–∏—Ä—É–π LLMProvider.chat() —Ç–∞–∫, —á—Ç–æ–±—ã –æ–Ω –≤–æ–∑–≤—Ä–∞—â–∞–ª JSON —Å domain –∏ sub_category.
   - –í—ã–∑–æ–≤–∏ crystallize_memories().
   - –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ —Ñ–∞–∫—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ domain –∏ sub_category.

–ò—Å–ø–æ–ª—å–∑—É–π monkeypatch –¥–ª—è –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è DB_PATH –Ω–∞ tmp_path / "test.db".
```

---

## –≠—Ç–∞–ø 3: –ê–≤—Ç–æ–Ω–æ–º–∏—è –∏ –°–∞–º–æ–æ–±—É—á–µ–Ω–∏–µ

**–¶–µ–ª—å**: –î–∞—Ç—å –∞–≥–µ–Ω—Ç—É —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å —Å–æ–∑–¥–∞–≤–∞—Ç—å –Ω–æ–≤—ã–µ –Ω–∞–≤—ã–∫–∏ (skills) –Ω–∞ –æ—Å–Ω–æ–≤–µ —É—Å–ø–µ—à–Ω—ã—Ö –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–µ–π –¥–µ–π—Å—Ç–≤–∏–π. –≠—Ç–æ –ø–æ–∑–≤–æ–ª–∏—Ç –µ–º—É ¬´–∑–∞–ø–æ–º–∏–Ω–∞—Ç—å¬ª —É–¥–∞—á–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è –∏ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏—Ö, —É—Å–∫–æ—Ä—è—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ—Ö–æ–∂–∏—Ö –∑–∞–¥–∞—á –≤ –±—É–¥—É—â–µ–º.

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è –∏–¥–µ—è**: –ö–æ–≥–¥–∞ –∞–≥–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Å–ª–æ–∂–Ω—É—é –∑–∞–¥–∞—á—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, ¬´–Ω–∞–π—Ç–∏ –≤—Å–µ –±–æ–ª—å—à–∏–µ —Ñ–∞–π–ª—ã –≤ –ø—Ä–æ–µ–∫—Ç–µ –∏ —Å–æ–∑–¥–∞—Ç—å –æ—Ç—á—ë—Ç¬ª), –æ–Ω –º–æ–∂–µ—Ç –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–≤–æ—é —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏—é (–ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å tool_calls) –∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–∑ –Ω–µ—ë –æ–±–æ–±—â—ë–Ω–Ω—É—é –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é ‚Äî –Ω–æ–≤—ã–π SKILL.md. –í —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–∑, –∫–æ–≥–¥–∞ –≤–æ–∑–Ω–∏–∫–Ω–µ—Ç –ø–æ—Ö–æ–∂–∞—è –∑–∞–¥–∞—á–∞, –∞–≥–µ–Ω—Ç –∑–∞–≥—Ä—É–∑–∏—Ç —ç—Ç–æ—Ç –Ω–∞–≤—ã–∫ –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç –∑–∞–¥–∞—á—É –±—ã—Å—Ç—Ä–µ–µ –∏ —Ç–æ—á–Ω–µ–µ.

---

### –ü–æ–¥—ç—Ç–∞–ø 3.1: –°–æ–∑–¥–∞–Ω–∏–µ –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞ –ù–∞–≤—ã–∫–æ–≤

**–ß—Ç–æ –¥–µ–ª–∞–µ–º**: –†–∞–∑—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –º–æ–¥—É–ª—å, –∫–æ—Ç–æ—Ä—ã–π –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π –∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∏–∑ –Ω–µ—ë –Ω–æ–≤—ã–π —Ñ–∞–π–ª SKILL.md.

**–ü—Ä–æ–º–ø—Ç –¥–ª—è Cursor ‚Ññ10:**

```
–ó–∞–¥–∞—á–∞: –°–æ–∑–¥–∞—Ç—å –º–æ–¥—É–ª—å SkillGenerator

–°–æ–∑–¥–∞–π —Ñ–∞–π–ª nanobot/agent/skill_generator.py.

1. –ò–º–ø–æ—Ä—Ç—ã:
   import json
   from pathlib import Path
   from typing import Any
   from loguru import logger
   from nanobot.providers.base import LLMProvider

2. –ö–æ–Ω—Å—Ç–∞–Ω—Ç–∞ SKILL_GENERATION_PROMPT:

SKILL_GENERATION_PROMPT = """Analyze the following successful tool call sequence from an AI agent session. Your task is to convert this into a generalized, reusable skill instruction.

**Tool Sequence:**
{tool_sequence}

**Instructions:**
1. Describe the overall GOAL of this sequence in one sentence.
2. Write a STEP-BY-STEP guide using the available tools (read_file, write_file, edit_file, list_dir, exec, web_search, web_fetch, memory_search).
3. GENERALIZE specific parameters: replace specific filenames with descriptions like "the target file", specific URLs with "the target URL", etc.
4. Include PREREQUISITES: what needs to be true before this skill can be used.
5. Include COMMON PITFALLS: based on any errors that occurred during the sequence.
6. Output clean, well-structured Markdown.

Example output:
## Goal
Find and analyze large files in a project directory.

## Prerequisites
- A project directory path must be known.

## Steps
1. Use `list_dir` to scan the project directory.
2. Use `exec` with `find . -size +10M` to locate large files.
3. For each large file, use `read_file` to check its content type.
4. Use `write_file` to create a summary report.

## Common Pitfalls
- The `find` command syntax differs between Windows and Linux. Use `dir` on Windows.
"""

3. –ö–æ–Ω—Å—Ç–∞–Ω—Ç–∞ SKILL_TEMPLATE:

SKILL_TEMPLATE = '''---
description: "{description}"
---

# {name}

{body}
'''

4. –ö–ª–∞—Å—Å SkillGenerator:

class SkillGenerator:
    def __init__(self, skills_dir: Path, provider: LLMProvider, model: str):
        self.skills_dir = skills_dir
        self.provider = provider
        self.model = model

    def _extract_tool_sequence(self, messages: list[dict[str, Any]]) -> str:
        """–ò–∑–≤–ª–µ–∫–∞–µ—Ç –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å tool_calls –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π."""
        sequence_parts = []
        for msg in messages:
            if msg.get("role") == "assistant" and msg.get("tool_calls"):
                for tc in msg["tool_calls"]:
                    func = tc.get("function", {})
                    name = func.get("name", "unknown")
                    args = func.get("arguments", "{}")
                    if isinstance(args, str):
                        try:
                            args = json.loads(args)
                        except json.JSONDecodeError:
                            pass
                    sequence_parts.append(f"Tool: {name}\nArguments: {json.dumps(args, indent=2, ensure_ascii=False)}")
            elif msg.get("role") == "tool":
                content = msg.get("content", "")
                # –°–æ–∫—Ä–∞—â–∞–µ–º –¥–ª–∏–Ω–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                if len(content) > 200:
                    content = content[:200] + "..."
                is_error = content.startswith("Error:")
                status = "ERROR" if is_error else "OK"
                sequence_parts.append(f"Result ({status}): {content}")
        
        return "\n\n".join(sequence_parts) if sequence_parts else "No tool calls found."

    async def create_skill_from_trajectory(
        self,
        skill_name: str,
        skill_description: str,
        messages: list[dict[str, Any]],
    ) -> str:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –Ω–æ–≤—ã–π –Ω–∞–≤—ã–∫ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π."""
        tool_sequence = self._extract_tool_sequence(messages)
        
        if tool_sequence == "No tool calls found.":
            return "Error: No tool calls found in the conversation history."
        
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ç–µ–ª–æ –Ω–∞–≤—ã–∫–∞ —á–µ—Ä–µ–∑ LLM
        prompt = SKILL_GENERATION_PROMPT.format(tool_sequence=tool_sequence)
        
        try:
            response = await self.provider.chat(
                messages=[
                    {"role": "system", "content": "You are a technical writer. Generate clear, reusable skill documentation."},
                    {"role": "user", "content": prompt},
                ],
                model=self.model,
                temperature=0.3,
                max_tokens=2000,
            )
            body = response.content or "No content generated."
        except Exception as e:
            logger.error(f"Skill generation LLM call failed: {e}")
            return f"Error: Failed to generate skill content: {e}"
        
        # –°–æ–±–∏—Ä–∞–µ–º SKILL.md
        skill_content = SKILL_TEMPLATE.format(
            name=skill_name,
            description=skill_description,
            body=body,
        )
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∞–π–ª
        skill_dir = self.skills_dir / skill_name
        skill_dir.mkdir(parents=True, exist_ok=True)
        skill_file = skill_dir / "SKILL.md"
        skill_file.write_text(skill_content, encoding="utf-8")
        
        logger.info(f"Skill '{skill_name}' created at {skill_file}")
        return f"Skill '{skill_name}' created successfully at {skill_file}"
```

---

### –ü–æ–¥—ç—Ç–∞–ø 3.2: –°–æ–∑–¥–∞–Ω–∏–µ –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ `create_skill`

**–ß—Ç–æ –¥–µ–ª–∞–µ–º**: –î–∞—ë–º –∞–≥–µ–Ω—Ç—É –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Å–∞–º–æ–º—É —Ä–µ—à–∞—Ç—å, –∫–æ–≥–¥–∞ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –Ω–∞–≤—ã–∫, —á–µ—Ä–µ–∑ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç.

**–ü—Ä–æ–º–ø—Ç –¥–ª—è Cursor ‚Ññ11:**

```
–ó–∞–¥–∞—á–∞: –°–æ–∑–¥–∞—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç CreateSkillTool

1. –°–æ–∑–¥–∞–π —Ñ–∞–π–ª nanobot/agent/tools/skill.py:

from typing import Any
from nanobot.agent.tools.base import Tool
from nanobot.agent.skill_generator import SkillGenerator
from nanobot.session.manager import SessionManager


class CreateSkillTool(Tool):
    """Tool for creating new skills from conversation history."""

    def __init__(self, skill_generator: SkillGenerator, session_manager: SessionManager):
        self._skill_generator = skill_generator
        self._session_manager = session_manager
        self._current_session_key: str | None = None

    def set_session_key(self, key: str) -> None:
        """Set the current session key for accessing conversation history."""
        self._current_session_key = key

    @property
    def name(self) -> str:
        return "create_skill"

    @property
    def description(self) -> str:
        return (
            "Create a new reusable skill from the current conversation. "
            "Use this when you have successfully completed a complex task "
            "and want to remember the approach for future use. "
            "The skill will be saved as a SKILL.md file."
        )

    @property
    def parameters(self) -> dict[str, Any]:
        return {
            "type": "object",
            "properties": {
                "skill_name": {
                    "type": "string",
                    "description": "A descriptive snake_case name (e.g., 'analyze_project_structure')."
                },
                "skill_description": {
                    "type": "string",
                    "description": "A one-sentence description of what the skill does."
                }
            },
            "required": ["skill_name", "skill_description"]
        }

    async def execute(self, skill_name: str, skill_description: str, **kwargs) -> str:
        if not self._current_session_key:
            return "Error: No active session. Cannot access conversation history."
        
        session = self._session_manager.get_or_create(self._current_session_key)
        if not session.messages:
            return "Error: No messages in current session."
        
        return await self._skill_generator.create_skill_from_trajectory(
            skill_name=skill_name,
            skill_description=skill_description,
            messages=session.get_history(max_messages=100),
        )

2. –û—Ç–∫—Ä–æ–π nanobot/agent/loop.py.

3. –î–æ–±–∞–≤—å –∏–º–ø–æ—Ä—Ç—ã:
   from nanobot.agent.skill_generator import SkillGenerator
   from nanobot.agent.tools.skill import CreateSkillTool

4. –í AgentLoop.__init__, –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è self.skills (–∏–ª–∏ self.context), –¥–æ–±–∞–≤—å:
   self.skill_generator = SkillGenerator(
       skills_dir=self.workspace / "skills",
       provider=provider,
       model=self.model,
   )

5. –í _register_default_tools, –¥–æ–±–∞–≤—å:
   create_skill_tool = CreateSkillTool(
       skill_generator=self.skill_generator,
       session_manager=self.sessions,
   )
   self.tools.register(create_skill_tool)

6. –í _process_message, –ø–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏ session = self.sessions.get_or_create(msg.session_key), –¥–æ–±–∞–≤—å:
   # –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è create_skill
   create_skill_tool = self.tools.get("create_skill")
   if isinstance(create_skill_tool, CreateSkillTool):
       create_skill_tool.set_session_key(msg.session_key)
```

---

### –ü–æ–¥—ç—Ç–∞–ø 3.3: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –°–æ–∑–¥–∞–Ω–∏—è –ù–∞–≤—ã–∫–æ–≤

**–ß—Ç–æ –¥–µ–ª–∞–µ–º**: –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å–ª–æ–∂–Ω–æ–π –∑–∞–¥–∞—á–∏ (–±–æ–ª–µ–µ 5 –∏—Ç–µ—Ä–∞—Ü–∏–π tool_calls –±–µ–∑ –æ—à–∏–±–æ–∫) –∞–≥–µ–Ω—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫–∞–∫ –Ω–∞–≤—ã–∫.

**–ü—Ä–æ–º–ø—Ç –¥–ª—è Cursor ‚Ññ12:**

```
–ó–∞–¥–∞—á–∞: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–∞–≤—ã–∫–∞

–û—Ç–∫—Ä–æ–π nanobot/agent/loop.py.

1. –í –º–µ—Ç–æ–¥–µ _process_message, –ø–æ—Å–ª–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ while (–ø–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏ final_content = response.content; break), –¥–æ–±–∞–≤—å –ª–æ–≥–∏–∫—É –∞–Ω–∞–ª–∏–∑–∞:

   # –ê–Ω–∞–ª–∏–∑: —Å—Ç–æ–∏—Ç –ª–∏ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–∞–≤—ã–∫–∞?
   if iteration >= 5 and final_content:
       # –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º —É—Å–ø–µ—à–Ω—ã–µ tool_calls (–±–µ–∑ –æ—à–∏–±–æ–∫)
       successful_calls = 0
       error_calls = 0
       for m in messages:
           if m.get("role") == "tool":
               content = m.get("content", "")
               if content.startswith("Error:"):
                   error_calls += 1
               else:
                   successful_calls += 1
       
       # –ï—Å–ª–∏ –±—ã–ª–æ >= 5 —É—Å–ø–µ—à–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤ –∏ –º–∞–ª–æ –æ—à–∏–±–æ–∫, –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –Ω–∞–≤—ã–∫
       if successful_calls >= 5 and error_calls <= 1:
           skill_suggestion = (
               "\n\n---\n"
               "üí° This was a complex task with multiple steps. "
               "Would you like me to save this as a reusable skill? "
               "Just say 'save as skill' and give it a name."
           )
           final_content += skill_suggestion

–í–∞–∂–Ω–æ: –≠—Ç–æ –º—è–≥–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ, –∞ –Ω–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∞–º —Ä–µ—à–∞–µ—Ç, —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –ª–∏ –Ω–∞–≤—ã–∫.
```

---

### –ü–æ–¥—ç—Ç–∞–ø 3.4: –¢–µ—Å—Ç—ã –¥–ª—è –ì–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ù–∞–≤—ã–∫–æ–≤

**–ß—Ç–æ –¥–µ–ª–∞–µ–º**: –°–æ–∑–¥–∞—ë–º —Ç–µ—Å—Ç—ã –¥–ª—è SkillGenerator –∏ CreateSkillTool.

**–ü—Ä–æ–º–ø—Ç –¥–ª—è Cursor ‚Ññ13:**

```
–ó–∞–¥–∞—á–∞: –ù–∞–ø–∏—Å–∞—Ç—å —Ç–µ—Å—Ç—ã –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –Ω–∞–≤—ã–∫–æ–≤

–°–æ–∑–¥–∞–π —Ñ–∞–π–ª tests/test_skill_generator.py.

1. test_extract_tool_sequence:
   - –°–æ–∑–¥–∞–π —Ç–µ—Å—Ç–æ–≤—ã–µ messages —Å assistant (tool_calls) –∏ tool (results).
   - –í—ã–∑–æ–≤–∏ _extract_tool_sequence().
   - –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –∏–º–µ–Ω–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –∏ –∞—Ä–≥—É–º–µ–Ω—Ç—ã.

2. test_create_skill_from_trajectory:
   - –ú–æ–∫–∏—Ä—É–π LLMProvider.chat() –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Ç–µ–ª–∞ –Ω–∞–≤—ã–∫–∞.
   - –í—ã–∑–æ–≤–∏ create_skill_from_trajectory() —Å tmp_path.
   - –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ —Ñ–∞–π–ª SKILL.md —Å–æ–∑–¥–∞–Ω –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏.
   - –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ –≤–∫–ª—é—á–∞–µ—Ç frontmatter —Å description.

3. test_create_skill_no_tool_calls:
   - –ü–µ—Ä–µ–¥–∞–π –ø—É—Å—Ç—ã–µ messages.
   - –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –æ—à–∏–±–∫–∞ "No tool calls found".

4. test_create_skill_tool_execute:
   - –ú–æ–∫–∏—Ä—É–π SessionManager –∏ SkillGenerator.
   - –í—ã–∑–æ–≤–∏ CreateSkillTool.execute().
   - –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ create_skill_from_trajectory –±—ã–ª –≤—ã–∑–≤–∞–Ω —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –∞—Ä–≥—É–º–µ–Ω—Ç–∞–º–∏.

5. test_create_skill_tool_no_session:
   - –ù–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–π session_key.
   - –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ execute() –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫—É.
```

---

## –≠—Ç–∞–ø 4: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –£–ª—É—á—à–µ–Ω–∏—è –∏ –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ

**–¶–µ–ª—å**: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –ø—Ä–æ–ø—É—â–µ–Ω—ã –∏–ª–∏ —Ç—Ä–µ–±—É—é—Ç –¥–æ—Ä–∞–±–æ—Ç–∫–∏, –∞ —Ç–∞–∫–∂–µ —É–ª—É—á—à–∏—Ç—å –æ–±—â—É—é –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç—å –∏ –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ—Å—Ç—å –∞–≥–µ–Ω—Ç–∞. –≠—Ç–æ—Ç —ç—Ç–∞–ø –∑–∞–∫—Ä—ã–≤–∞–µ—Ç —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –¥–æ–ª–≥ –∏ –ø–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ—Ç —Å–∏—Å—Ç–µ–º—É –∫ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ–º—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é.

---

### –ü–æ–¥—ç—Ç–∞–ø 4.1: –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ú–µ—Ö–∞–Ω–∏–∑–º–∞ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è (ToolPolicy FSM)

**–ß—Ç–æ –¥–µ–ª–∞–µ–º**: –†–µ–∞–ª–∏–∑—É–µ–º –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π –º–µ—Ö–∞–Ω–∏–∑–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –¥–ª—è –æ–ø–∞—Å–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤. –°–µ–π—á–∞—Å `ExecTool` –ø–æ–º–µ—á–µ–Ω –∫–∞–∫ `REQUIRE_CONFIRMATION`, –Ω–æ –∞–≥–µ–Ω—Ç –Ω–µ –∂–¥—ë—Ç –æ—Ç–≤–µ—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ú—ã —Ä–µ–∞–ª–∏–∑—É–µ–º —ç—Ç–æ —á–µ—Ä–µ–∑ –º–∞—à–∏–Ω—É —Å–æ—Å—Ç–æ—è–Ω–∏–π (FSM) –≤ —Å–µ—Å—Å–∏–∏.

**–ü—Ä–æ–º–ø—Ç –¥–ª—è Cursor ‚Ññ14:**

```
–ó–∞–¥–∞—á–∞: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å ToolPolicy —Å –æ–∂–∏–¥–∞–Ω–∏–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è

–≠—Ç–æ —Å–∞–º—ã–π —Å–ª–æ–∂–Ω—ã–π –ø–æ–¥—ç—Ç–∞–ø. –ù—É–∂–Ω–æ –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–∞–π–ª–æ–≤.

--- –®–∞–≥ 1: –°–æ–∑–¥–∞—Ç—å/–æ–±–Ω–æ–≤–∏—Ç—å ToolPolicy ---

–°–æ–∑–¥–∞–π —Ñ–∞–π–ª nanobot/agent/tools/policy.py (–µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç):

from enum import Enum

class ToolPolicy(str, Enum):
    ALLOW = "allow"
    REQUIRE_CONFIRMATION = "require_confirmation"
    DENY = "deny"

--- –®–∞–≥ 2: –î–æ–±–∞–≤–∏—Ç—å policy –≤ –±–∞–∑–æ–≤—ã–π Tool ---

–û—Ç–∫—Ä–æ–π nanobot/agent/tools/base.py.

–î–æ–±–∞–≤—å –∏–º–ø–æ—Ä—Ç: from nanobot.agent.tools.policy import ToolPolicy

–î–æ–±–∞–≤—å —Å–≤–æ–π—Å—Ç–≤–æ –≤ –∫–ª–∞—Å—Å Tool (–ø–æ—Å–ª–µ –º–µ—Ç–æ–¥–∞ to_schema):

    @property
    def policy(self) -> ToolPolicy:
        """Security policy for this tool. Override in subclasses."""
        return ToolPolicy.ALLOW

--- –®–∞–≥ 3: –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å policy –≤ ExecTool ---

–û—Ç–∫—Ä–æ–π nanobot/agent/tools/shell.py.

–î–æ–±–∞–≤—å –∏–º–ø–æ—Ä—Ç: from nanobot.agent.tools.policy import ToolPolicy

–î–æ–±–∞–≤—å —Å–≤–æ–π—Å—Ç–≤–æ –≤ –∫–ª–∞—Å—Å ExecTool:

    @property
    def policy(self) -> ToolPolicy:
        return ToolPolicy.REQUIRE_CONFIRMATION

--- –®–∞–≥ 4: –î–æ–±–∞–≤–∏—Ç—å get_policy –≤ ToolRegistry ---

–û—Ç–∫—Ä–æ–π nanobot/agent/tools/registry.py.

–î–æ–±–∞–≤—å –∏–º–ø–æ—Ä—Ç: from nanobot.agent.tools.policy import ToolPolicy

–î–æ–±–∞–≤—å –º–µ—Ç–æ–¥:

    def get_policy(self, name: str) -> ToolPolicy:
        """Get the security policy for a tool."""
        tool = self.get(name)
        return tool.policy if tool else ToolPolicy.DENY

--- –®–∞–≥ 5: –î–æ–±–∞–≤–∏—Ç—å pending state –≤ Session ---

–û—Ç–∫—Ä–æ–π nanobot/session/manager.py.

–í dataclass Session, –¥–æ–±–∞–≤—å –ø–æ–ª–µ:
    pending_confirmation: dict[str, Any] | None = None

–û–±–Ω–æ–≤–∏ –º–µ—Ç–æ–¥ get_history, —á—Ç–æ–±—ã –æ–Ω –ù–ï –≤–∫–ª—é—á–∞–ª pending_confirmation –≤ –∏—Å—Ç–æ—Ä–∏—é (—ç—Ç–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ).

–û–±–Ω–æ–≤–∏ _load –∏ save, —á—Ç–æ–±—ã –æ–Ω–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Å–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–ª–∏/–¥–µ—Å–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–ª–∏ pending_confirmation. –í save, –¥–æ–±–∞–≤—å pending_confirmation –≤ metadata:

    metadata_line = {
        "_type": "metadata",
        "created_at": session.created_at.isoformat(),
        "updated_at": session.updated_at.isoformat(),
        "metadata": session.metadata,
        "pending_confirmation": session.pending_confirmation,
    }

–í _load, –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–π:
    pending_confirmation = data.get("pending_confirmation")

–ò –ø–µ—Ä–µ–¥–∞–≤–∞–π –≤ Session(..., pending_confirmation=pending_confirmation).

--- –®–∞–≥ 6: –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ AgentLoop ---

–û—Ç–∫—Ä–æ–π nanobot/agent/loop.py.

–î–æ–±–∞–≤—å –∏–º–ø–æ—Ä—Ç: from nanobot.agent.tools.policy import ToolPolicy

–ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É–π _process_message:

A) –í —Å–∞–º–æ–º –Ω–∞—á–∞–ª–µ –º–µ—Ç–æ–¥–∞, –ü–û–°–õ–ï –ø–æ–ª—É—á–µ–Ω–∏—è session, –¥–æ–±–∞–≤—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ–∂–∏–¥–∞—é—â–µ–≥–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è:

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –æ–∂–∏–¥–∞—é—â–µ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
    if session.pending_confirmation:
        return await self._handle_confirmation(msg, session)

B) –°–æ–∑–¥–∞–π –Ω–æ–≤—ã–π –º–µ—Ç–æ–¥ _handle_confirmation:

    async def _handle_confirmation(self, msg: InboundMessage, session: Session) -> OutboundMessage | None:
        """Handle user response to a pending tool confirmation."""
        pending = session.pending_confirmation
        user_response = msg.content.strip().lower()
        
        # –ü—Ä–∏–Ω–∏–º–∞–µ–º: yes, –¥–∞, y, –¥, ok, –æ–∫
        affirmative = {"yes", "–¥–∞", "y", "–¥", "ok", "–æ–∫", "1", "true"}
        # –û—Ç–∫–ª–æ–Ω—è–µ–º: no, –Ω–µ—Ç, n, –Ω, cancel, –æ—Ç–º–µ–Ω–∞
        negative = {"no", "–Ω–µ—Ç", "n", "–Ω", "cancel", "–æ—Ç–º–µ–Ω–∞", "0", "false"}
        
        # –û—á–∏—â–∞–µ–º pending
        session.pending_confirmation = None
        self.sessions.save(session)
        
        if user_response in affirmative:
            # –í—ã–ø–æ–ª–Ω—è–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π –≤—ã–∑–æ–≤
            tool_name = pending["name"]
            tool_args = pending["arguments"]
            logger.info(f"Confirmed: executing {tool_name}")
            result = await self.tools.execute(tool_name, tool_args)
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
            session.add_message("user", msg.content)
            session.add_message("assistant", f"‚úÖ Executed `{tool_name}`: {result[:500]}")
            self.sessions.save(session)
            
            return OutboundMessage(
                channel=msg.channel,
                chat_id=msg.chat_id,
                content=f"‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ `{tool_name}`:\n{result[:2000]}"
            )
        elif user_response in negative:
            session.add_message("user", msg.content)
            session.add_message("assistant", "‚ùå Operation cancelled.")
            self.sessions.save(session)
            
            return OutboundMessage(
                channel=msg.channel,
                chat_id=msg.chat_id,
                content="‚ùå –û–ø–µ—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞."
            )
        else:
            # –ù–µ–ø–æ–Ω—è—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç ‚Äî –ø–µ—Ä–µ—Å–ø—Ä–∞—à–∏–≤–∞–µ–º
            session.pending_confirmation = pending  # –í–æ–∑–≤—Ä–∞—â–∞–µ–º pending
            self.sessions.save(session)
            
            return OutboundMessage(
                channel=msg.channel,
                chat_id=msg.chat_id,
                content=f"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–≤–µ—Ç—å—Ç–µ 'yes' –∏–ª–∏ 'no'. –û–∂–∏–¥–∞–µ—Ç—Å—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –¥–ª—è `{pending['name']}`."
            )

C) –í —Ü–∏–∫–ª–µ for tool_call in response.tool_calls, –ü–ï–†–ï–î –≤—ã–∑–æ–≤–æ–º self.tools.execute, –¥–æ–±–∞–≤—å –ø—Ä–æ–≤–µ—Ä–∫—É:

    for tool_call in response.tool_calls:
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª–∏—Ç–∏–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
        policy = self.tools.get_policy(tool_call.name)
        if policy == ToolPolicy.DENY:
            result = f"Error: Tool '{tool_call.name}' is denied by security policy."
            messages = self.context.add_tool_result(messages, tool_call.id, tool_call.name, result)
            continue
        
        if policy == ToolPolicy.REQUIRE_CONFIRMATION:
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–∑–æ–≤ –∏ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
            session.pending_confirmation = {
                "id": tool_call.id,
                "name": tool_call.name,
                "arguments": tool_call.arguments,
                "messages_snapshot_len": len(messages),  # –î–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
            }
            self.sessions.save(session)
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º —á–∏—Ç–∞–µ–º–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
            args_preview = json.dumps(tool_call.arguments, ensure_ascii=False, indent=2)
            if len(args_preview) > 500:
                args_preview = args_preview[:500] + "..."
            
            confirmation_msg = (
                f"‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ:\n\n"
                f"–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç: `{tool_call.name}`\n"
                f"–ê—Ä–≥—É–º–µ–Ω—Ç—ã:\n```\n{args_preview}\n```\n\n"
                f"–í—ã–ø–æ–ª–Ω–∏—Ç—å? (yes/no)"
            )
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
            session.add_message("user", msg.content)
            session.add_message("assistant", confirmation_msg)
            self.sessions.save(session)
            
            return OutboundMessage(
                channel=msg.channel,
                chat_id=msg.chat_id,
                content=confirmation_msg,
            )
        
        # –û–±—ã—á–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ (policy == ALLOW)
        args_str = json.dumps(tool_call.arguments, ensure_ascii=False)
        logger.info(f"Tool call: {tool_call.name}({args_str[:200]})")
        result = await self.tools.execute(tool_call.name, tool_call.arguments)
        
        # ... (—Ä–µ—Ñ–ª–µ–∫—Å–∏—è –ø—Ä–∏ –æ—à–∏–±–∫–µ, –∫–∞–∫ –≤ –ø–æ–¥—ç—Ç–∞–ø–µ 1.2) ...
        
        messages = self.context.add_tool_result(
            messages, tool_call.id, tool_call.name, result
        )
```

---

### –ü–æ–¥—ç—Ç–∞–ø 4.2: –£–ª—É—á—à–µ–Ω–∏–µ –ü—Ä–æ–∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ü–æ–≤–µ–¥–µ–Ω–∏—è (Heartbeat)

**–ß—Ç–æ –¥–µ–ª–∞–µ–º**: –î–µ–ª–∞–µ–º Heartbeat –±–æ–ª–µ–µ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–º ‚Äî –≤–º–µ—Å—Ç–æ –ø—Ä–æ—Å—Ç–æ–≥–æ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞, –∞–≥–µ–Ω—Ç –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Å–≤–æ—ë —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Ä–µ—à–µ–Ω–∏—è.

**–ü—Ä–æ–º–ø—Ç –¥–ª—è Cursor ‚Ññ15:**

```
–ó–∞–¥–∞—á–∞: –£–ª—É—á—à–∏—Ç—å Heartbeat-–ø—Ä–æ–º—Ç

–û—Ç–∫—Ä–æ–π nanobot/heartbeat/service.py.

1. –ó–∞–º–µ–Ω–∏ HEARTBEAT_PROMPT –Ω–∞:

HEARTBEAT_PROMPT = """This is your periodic heartbeat check. Perform the following analysis:

1. **Check HEARTBEAT.md**: Read it from your workspace. Execute any tasks listed there.
2. **Review recent memory**: Use memory_search to check if there are any pending items or reminders.
3. **System health**: If relevant, check system status (disk space, running processes).

After your analysis:
- If you took any action, summarize what you did.
- If nothing needs attention, reply with just: HEARTBEAT_OK

Be efficient ‚Äî this runs periodically, so keep it brief."""

2. –í –º–µ—Ç–æ–¥–µ _tick, –¥–æ–±–∞–≤—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:

   import time
   
   async def _tick(self) -> None:
       start = time.monotonic()
       content = self._read_heartbeat_file()
       
       if _is_heartbeat_empty(content):
           logger.debug("Heartbeat: no tasks (HEARTBEAT.md empty)")
           return
       
       logger.info("Heartbeat: checking for tasks...")
       
       if self.on_heartbeat:
           try:
               response = await self.on_heartbeat(HEARTBEAT_PROMPT)
               elapsed = time.monotonic() - start
               
               if HEARTBEAT_OK_TOKEN.replace("_", "") in response.upper().replace("_", ""):
                   logger.info(f"Heartbeat: OK ({elapsed:.1f}s)")
               else:
                   logger.info(f"Heartbeat: completed task ({elapsed:.1f}s)")
           except Exception as e:
               logger.error(f"Heartbeat execution failed: {e}")
```

---

### –ü–æ–¥—ç—Ç–∞–ø 4.3: –ú–µ—Ç—Ä–∏–∫–∏ –∏ –ù–∞–±–ª—é–¥–∞–µ–º–æ—Å—Ç—å

**–ß—Ç–æ –¥–µ–ª–∞–µ–º**: –°–æ–∑–¥–∞—ë–º –º–æ–¥—É–ª—å –¥–ª—è —Å–±–æ—Ä–∞ –º–µ—Ç—Ä–∏–∫ —Ä–∞–±–æ—Ç—ã –∞–≥–µ–Ω—Ç–∞ ‚Äî –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏—Ç–µ—Ä–∞—Ü–∏–π, –æ—à–∏–±–æ–∫, —Ä–µ—Ñ–ª–µ–∫—Å–∏–π, —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –Ω–∞–≤—ã–∫–æ–≤. –≠—Ç–æ –ø–æ–∑–≤–æ–ª–∏—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å ¬´–∑–¥–æ—Ä–æ–≤—å–µ¬ª –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∞–≥–µ–Ω—Ç–∞.

**–ü—Ä–æ–º–ø—Ç –¥–ª—è Cursor ‚Ññ16:**

```
–ó–∞–¥–∞—á–∞: –°–æ–∑–¥–∞—Ç—å –º–æ–¥—É–ª—å –º–µ—Ç—Ä–∏–∫

1. –°–æ–∑–¥–∞–π —Ñ–∞–π–ª nanobot/agent/metrics.py:

from dataclasses import dataclass, field
from datetime import datetime
from loguru import logger


@dataclass
class SessionMetrics:
    """–ú–µ—Ç—Ä–∏–∫–∏ –æ–¥–Ω–æ–π —Å–µ—Å—Å–∏–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è."""
    started_at: datetime = field(default_factory=datetime.now)
    iterations: int = 0
    tool_calls_total: int = 0
    tool_calls_failed: int = 0
    reflections_triggered: int = 0
    confirmations_requested: int = 0
    skills_created: int = 0
    tokens_used: int = 0

    def to_dict(self) -> dict:
        return {
            "started_at": self.started_at.isoformat(),
            "duration_s": (datetime.now() - self.started_at).total_seconds(),
            "iterations": self.iterations,
            "tool_calls_total": self.tool_calls_total,
            "tool_calls_failed": self.tool_calls_failed,
            "reflections_triggered": self.reflections_triggered,
            "confirmations_requested": self.confirmations_requested,
            "skills_created": self.skills_created,
        }

    def log_summary(self) -> None:
        d = self.to_dict()
        logger.info(
            f"Session metrics: {d['iterations']} iterations, "
            f"{d['tool_calls_total']} tool calls ({d['tool_calls_failed']} failed), "
            f"{d['reflections_triggered']} reflections, "
            f"{d['duration_s']:.1f}s"
        )

2. –û—Ç–∫—Ä–æ–π nanobot/agent/loop.py.

3. –î–æ–±–∞–≤—å –∏–º–ø–æ—Ä—Ç: from nanobot.agent.metrics import SessionMetrics

4. –í _process_message, –≤ –Ω–∞—á–∞–ª–µ –º–µ—Ç–æ–¥–∞ —Å–æ–∑–¥–∞–π:
   metrics = SessionMetrics()

5. –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∏—Ä—É–π –º–µ—Ç—Ä–∏–∫–∏ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö –º–µ—Å—Ç–∞—Ö:
   - metrics.iterations += 1 ‚Äî –≤ –Ω–∞—á–∞–ª–µ –∫–∞–∂–¥–æ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏ while
   - metrics.tool_calls_total += 1 ‚Äî –ø—Ä–∏ –∫–∞–∂–¥–æ–º –≤—ã–∑–æ–≤–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
   - metrics.tool_calls_failed += 1 ‚Äî –ø—Ä–∏ –æ—à–∏–±–∫–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
   - metrics.reflections_triggered += 1 ‚Äî –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Ä–µ—Ñ–ª–µ–∫—Å–∏–∏
   - metrics.confirmations_requested += 1 ‚Äî –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è

6. –í –∫–æ–Ω—Ü–µ _process_message, –ø–µ—Ä–µ–¥ return, –¥–æ–±–∞–≤—å:
   metrics.log_summary()
```

---

## –ü–æ—Ä—è–¥–æ–∫ –í—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∏ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

–ù–∏–∂–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∞ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø–æ–¥—ç—Ç–∞–ø–æ–≤ —Å —É—á—ë—Ç–æ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –º–µ–∂–¥—É –Ω–∏–º–∏.

| –û—á–µ—Ä–µ–¥—å | –ü–æ–¥—ç—Ç–∞–ø | –ó–∞–≤–∏—Å–∏—Ç –æ—Ç | –û—Ü–µ–Ω–∫–∞ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ |
|---------|---------|------------|-------------------|
| 1 | 4.1 (ToolPolicy FSM) | ‚Äî | –í—ã—Å–æ–∫–∞—è |
| 2 | 1.1 (–ú–æ–¥—É–ª—å –†–µ—Ñ–ª–µ–∫—Å–∏–∏) | ‚Äî | –°—Ä–µ–¥–Ω—è—è |
| 3 | 1.2 (–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –†–µ—Ñ–ª–µ–∫—Å–∏–∏) | 1.1 | –°—Ä–µ–¥–Ω—è—è |
| 4 | 1.3 (–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ—Ñ–ª–µ–∫—Å–∏–π) | 1.2 | –ù–∏–∑–∫–∞—è |
| 5 | 1.4 (–¢–µ—Å—Ç—ã –†–µ—Ñ–ª–µ–∫—Å–∏–∏) | 1.1, 1.2, 1.3 | –°—Ä–µ–¥–Ω—è—è |
| 6 | 2.1 (–ú–∏–≥—Ä–∞—Ü–∏—è –ë–î) | ‚Äî | –°—Ä–µ–¥–Ω—è—è |
| 7 | 2.2 (–ö—Ä–∏—Å—Ç–∞–ª–ª–∏–∑–∞—Ü–∏—è) | 2.1 | –°—Ä–µ–¥–Ω—è—è |
| 8 | 2.3 (memory_search) | 2.1 | –°—Ä–µ–¥–Ω—è—è |
| 9 | 2.4 (–ê–≤—Ç–æ-–∫–æ–Ω—Ç–µ–∫—Å—Ç) | 2.1, 2.3 | –ù–∏–∑–∫–∞—è |
| 10 | 2.5 (–¢–µ—Å—Ç—ã H-MEM) | 2.1‚Äì2.4 | –°—Ä–µ–¥–Ω—è—è |
| 11 | 3.1 (–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –Ω–∞–≤—ã–∫–æ–≤) | ‚Äî | –°—Ä–µ–¥–Ω—è—è |
| 12 | 3.2 (create_skill) | 3.1 | –°—Ä–µ–¥–Ω—è—è |
| 13 | 3.3 (–ê–≤—Ç–æ-–ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ) | 3.2 | –ù–∏–∑–∫–∞—è |
| 14 | 3.4 (–¢–µ—Å—Ç—ã –Ω–∞–≤—ã–∫–æ–≤) | 3.1, 3.2 | –°—Ä–µ–¥–Ω—è—è |
| 15 | 4.2 (Heartbeat) | 2.3 | –ù–∏–∑–∫–∞—è |
| 16 | 4.3 (–ú–µ—Ç—Ä–∏–∫–∏) | 1.2, 4.1 | –ù–∏–∑–∫–∞—è |

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –ø—É—Ç—å**: 4.1 ‚Üí 1.1 ‚Üí 1.2 ‚Üí 1.3 ‚Üí 2.1 ‚Üí 2.2 ‚Üí 2.3 ‚Üí 3.1 ‚Üí 3.2

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**: –ù–∞—á–∞—Ç—å —Å –ø–æ–¥—ç—Ç–∞–ø–∞ **4.1 (ToolPolicy FSM)**, —Ç–∞–∫ –∫–∞–∫ —ç—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏, –∫–æ—Ç–æ—Ä–∞—è –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –¥–æ –ª—é–±—ã—Ö –¥—Ä—É–≥–∏—Ö —É–ª—É—á—à–µ–Ω–∏–π. –ó–∞—Ç–µ–º –ø–µ—Ä–µ–π—Ç–∏ –∫ –≠—Ç–∞–ø—É 1 (–†–µ—Ñ–ª–µ–∫—Å–∏—è), —Ç–∞–∫ –∫–∞–∫ –æ–Ω –∑–∞–∫–ª–∞–¥—ã–≤–∞–µ—Ç —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç –¥–ª—è —Å–∞–º–æ–∫–æ—Ä—Ä–µ–∫—Ü–∏–∏.

---

**–ê–≤—Ç–æ—Ä**: Manus (–°—Ç—Ä–∞—Ç–µ–≥ –∏ –ê—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä)
**–î–ª—è**: –ì.–í–∞–≥—É—Å (–æ–¥–æ–±—Ä–µ–Ω–∏–µ), Cursor (—Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è), nanobot (–∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è)
