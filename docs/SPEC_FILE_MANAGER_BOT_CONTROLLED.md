# Спецификация: Файловый менеджер, управляемый Nano Bot

**Версия:** 0.1  
**Дата:** 2026-02  
**Статус:** Черновик для аналитиков и планировщиков  

---

## 1. Резюме

Документ описывает концепцию **настольного/веб-приложения для работы с файлами и папками**, которое полностью управляется Nano Bot. Пользователь видит интерфейс (дерево папок, просмотр/редактирование файлов), а источник команд — бот: он решает, что показывать, создавать, удалять и изменять.

**Целевая аудитория:** Аналитики → Планировщики → Разработчики.

---

## 2. Цели и задачи

### 2.1 Бизнес-цели

| ID | Цель | Описание |
|----|------|----------|
| G1 | Контроль через бота | Все операции с файлами инициируются ботом, не пользователем |
| G2 | Прозрачность | Пользователь видит в UI, что делает бот в реальном времени |
| G3 | Безопасность | Доступ только к разрешённым директориям (workspace) |
| G4 | Удобство | Интерфейс как у привычного файлового менеджера / IDE |

### 2.2 Пользовательские сценарии

| Сценарий | Описание |
|----------|----------|
| S1 | Пользователь: «Покажи структуру проекта» | Бот вызывает `list_dir`, приложение обновляет дерево |
| S2 | Пользователь: «Создай папку reports и положи туда summary.md» | Бот создаёт папку и файл, UI показывает результат |
| S3 | Пользователь: «Открой main.py» | Бот отправляет команду `open`, приложение показывает содержимое в просмотрщике |
| S4 | Пользователь: «Измени 3-ю строку в config.yaml» | Бот использует `edit_file` / аналог, UI обновляет превью |
| S5 | Фоновый сценарий | Cron/субагент пишет файлы; приложение обновляет дерево при изменении (watch) |

---

## 3. Архитектура

### 3.1 Высокоуровневая схема

```
┌─────────────────────────────────────────────────────────────────┐
│                         ПОЛЬЗОВАТЕЛЬ                              │
│         (Telegram / CLI / другой канал)                            │
└────────────────────────────┬────────────────────────────────────┘
                              │ текстовые команды
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                       NANO BOT                                    │
│  • LLM (OpenRouter / и др.)                                       │
│  • Инструмент file_manager_api                                    │
│  • Вызывает HTTP API приложения                                   │
└────────────────────────────┬────────────────────────────────────┘
                              │ HTTP (localhost)
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│              FILE MANAGER APPLICATION                             │
│  • API-сервер (REST / WebSocket)                                  │
│  • GUI: дерево папок + просмотр/редактор файлов                   │
│  • Работа с диском (read, write, list, mkdir, delete)             │
│  • Watch / push-уведомления в UI при изменениях                   │
└────────────────────────────┬────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                    ФАЙЛОВАЯ СИСТЕМА                               │
│  workspace/ (AGENT_WORKSPACE)                                    │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 Потоки данных

1. **Команда → Бот → API → UI**  
   Пользователь пишет боту → бот вызывает инструмент → инструмент дергает API приложения → приложение обновляет UI.

2. **API → Диск → UI**  
   API выполняет операции с файлами и возвращает обновлённое состояние, UI перерисовывает дерево/превью.

3. **Watch (опционально)**  
   Приложение следит за изменениями в workspace (watchdog/inotify) и обновляет UI при изменениях вне API (например, от cron/субагента).

---

## 4. Спецификация API

**Базовый URL:** `http://127.0.0.1:8765` (настраиваемый порт)

**Формат:** JSON, UTF-8

### 4.1 Endpoints

#### `POST /api/list`

Список содержимого директории.

| Параметр | Тип   | Обязательный | Описание                          |
|----------|-------|--------------|-----------------------------------|
| path     | string| нет (default: "") | Относительный путь от workspace |

**Ответ:**
```json
{
  "entries": [
    {"name": "src", "type": "dir", "path": "src"},
    {"name": "main.py", "type": "file", "path": "main.py", "size": 1024}
  ],
  "current_path": "."
}
```

---

#### `POST /api/read`

Чтение содержимого файла.

| Параметр | Тип   | Обязательный | Описание    |
|----------|-------|--------------|-------------|
| path     | string| да           | Относительный путь к файлу |

**Ответ:**
```json
{
  "content": "...",
  "path": "src/main.py",
  "encoding": "utf-8"
}
```

**Ошибка:** `{"error": "File not found"}` и т.п.

---

#### `POST /api/write`

Запись в файл (создаёт родительские папки при необходимости).

| Параметр | Тип   | Обязательный | Описание   |
|----------|-------|--------------|------------|
| path     | string| да           | Путь к файлу |
| content  | string| да           | Содержимое |

**Ответ:**
```json
{
  "ok": true,
  "path": "reports/summary.md",
  "bytes_written": 256
}
```

---

#### `POST /api/create_dir`

Создание директории.

| Параметр | Тип   | Обязательный | Описание |
|----------|-------|--------------|----------|
| path     | string| да           | Путь к новой папке |

**Ответ:**
```json
{
  "ok": true,
  "path": "reports/2026"
}
```

---

#### `POST /api/delete`

Удаление файла или пустой папки.

| Параметр | Тип   | Обязательный | Описание      |
|----------|-------|--------------|---------------|
| path     | string| да           | Путь к объекту |
| recursive| bool  | нет (false)  | Удалять папку рекурсивно |

**Ответ:**
```json
{
  "ok": true,
  "path": "temp/old.txt"
}
```

---

#### `POST /api/open` (опционально)

«Открыть» файл в UI (передать path для подсветки / фокуса в редакторе).

| Параметр | Тип   | Обязательный | Описание |
|----------|-------|--------------|----------|
| path     | string| да           | Путь к файлу |

---

#### `GET /api/health`

Проверка доступности приложения.

**Ответ:**
```json
{
  "status": "ok",
  "workspace": "/path/to/workspace",
  "version": "0.1"
}
```

---

### 4.2 Обработка ошибок

Все ошибки в HTTP 4xx/5xx с телом:

```json
{
  "error": "Human-readable message",
  "code": "FILE_NOT_FOUND"
}
```

Типовые коды: `FILE_NOT_FOUND`, `PATH_OUTSIDE_WORKSPACE`, `NOT_A_FILE`, `NOT_A_DIR`, `DELETE_FAILED`.

---

## 5. Интеграция с Nano Bot

### 5.1 Новый инструмент: `file_manager_api`

Инструмент вызывает API File Manager вместо прямых операций с диском (как альтернатива или дополнение к `read_file` / `write_file`).

**Параметры (обобщённо):**

| Параметр  | Тип   | Описание                                |
|-----------|-------|----------------------------------------|
| action    | string| `list`, `read`, `write`, `create_dir`, `delete`, `open` |
| path      | string| Путь (относительно workspace)          |
| content   | string| Только для `write`                      |
| recursive | bool  | Только для `delete` (опционально)      |

**Пример вызова от бота:**

```json
{
  "action": "list",
  "path": "src"
}
```

```json
{
  "action": "write",
  "path": "reports/summary.md",
  "content": "# Summary\n\n..."
}
```

### 5.2 Конфигурация

Добавить в `nanobot/config/schema.py`:

```python
class FileManagerConfig(BaseModel):
    enabled: bool = False
    api_url: str = "http://127.0.0.1:8765"
    timeout: int = 10
```

В `.env`:

```
FILE_MANAGER_ENABLED=true
FILE_MANAGER_API_URL=http://127.0.0.1:8765
```

### 5.3 Поведение при недоступности API

Если приложение не запущено или не отвечает:

- Инструмент возвращает: `Error: File Manager app is not running. Start it to enable visual file operations.`
- Бот может использовать стандартные `read_file` / `write_file` как fallback.

---

## 6. GUI приложения (концепт)

### 6.1 Экраны

| Экран      | Описание |
|------------|----------|
| Дерево     | Дерево папок workspace (сворачиваемое) |
| Список     | Содержимое выбранной папки (таблица/список) |
| Просмотр   | Текстовое содержимое выбранного файла |
| Редактор   | (Опционально) Редактирование с сохранением обратно через API |

### 6.2 Обновление UI

1. **По запросу** — после каждого ответа API бот получает результат, приложение может отправить обновление в UI (REST → WebSocket push или polling).
2. **По watch** — приложение следит за изменениями в workspace и обновляет дерево при изменении файлов/папок.
3. **По команде** — при вызове `/api/open` UI переключается на нужный файл/папку.

### 6.3 Технологии (варианты)

| Вариант   | Плюсы                         | Минусы                     |
|-----------|-------------------------------|-----------------------------|
| Electron  | Опыт, кроссплатформенность    | Размер приложения           |
| Tauri     | Лёгкость, Rust backend       | Сложнее стека               |
| Flet     | Python, быстрый прототип     | Менее гибкий UI             |
| Веб + Flask/FastAPI | Просто, без установки | Нет нативного окна         |

**Рекомендация для MVP:** Веб (Flask/FastAPI + простой фронт) или Flet.

---

## 7. Безопасность

### 7.1 Ограничение путей

- Все пути резолвятся относительно `AGENT_WORKSPACE`.
- Запрещён выход за workspace (проверка `..`, абсолютных путей).
- Симлинки — по политике (разрешены/запрещены).

### 7.2 Сеть

- API слушает только `127.0.0.1` (localhost).
- Опционально: простой shared secret / API key в заголовке для защиты от других локальных приложений.

### 7.3 Аудит

- Логирование всех операций (кто, что, когда).
- Опционально: история последних N операций в UI.

---

## 8. Этапы реализации (Roadmap)

### Этап 1: API + минимальный клиент (2–3 недели)

| Задача | Описание |
|--------|----------|
| 1.1    | API-сервер (FastAPI) с endpoints: list, read, write, create_dir, delete |
| 1.2    | Проверка путей (в рамках workspace) |
| 1.3    | Простой веб-клиент: дерево + просмотр файла |
| 1.4    | Инструмент `file_manager_api` в боте |
| 1.5    | Конфиг и fallback при недоступности API |

### Этап 2: UX и стабильность (2 недели)

| Задача | Описание |
|--------|----------|
| 2.1    | WebSocket или polling для обновления UI после операций |
| 2.2    | Watch папки workspace и автообновление дерева |
| 2.3    | Подсветка синтаксиса в просмотрщике (опционально) |
| 2.4    | Обработка ошибок и информирование пользователя |

### Этап 3: Десктоп и доработки (2–4 недели)

| Задача | Описание |
|--------|----------|
| 3.1    | Сборка десктоп-приложения (Electron/Tauri) |
| 3.2    | Режим редактирования с сохранением через API |
| 3.3    | Интеграция с ToolPolicy (подтверждение для delete) |
| 3.4    | Документация и сценарии использования |

---

## 9. Зависимости и ограничения

### 9.1 Зависимости от Nano Bot

- Работающий Nano Bot с каналом (Telegram, CLI и т.п.).
- Настроенный `AGENT_WORKSPACE`.
- Доступ к localhost (запуск приложения на той же машине).

### 9.2 Ограничения

- Один workspace на экземпляр приложения.
- API без аутентификации по умолчанию (localhost only).
- Большие файлы (>10 MB) — по необходимости: стриминг, пагинация.

---

## 10. Критерии приёмки (MVP)

| ID | Критерий |
|----|----------|
| C1 | Бот по команде пользователя может показать дерево workspace через инструмент |
| C2 | Бот может создать папку/файл, пользователь видит изменения в UI |
| C3 | Бот может прочитать и записать файл через API |
| C4 | Пути вне workspace отклоняются с понятной ошибкой |
| C5 | При остановленном приложении бот возвращает корректное сообщение об ошибке |

---

## 11. Открытые вопросы для аналитиков

1. Нужен ли режим «только просмотр» (без write/delete)?
2. Нужна ли поддержка нескольких workspace одновременно?
3. Какой приоритет: веб или десктоп для первой версии?
4. Нужна ли интеграция с MCP вместо/вместе с REST API?
5. Нужен ли визуальный diff при изменении файлов ботом?

---

## 12. Глоссарий

| Термин      | Определение |
|-------------|-------------|
| Workspace   | Директория, задаваемая AGENT_WORKSPACE, корень для всех операций |
| Tool        | Инструмент Nano Bot, вызываемый LLM для выполнения действий |
| File Manager App | Отдельное приложение с API и GUI для работы с файлами |
| Watch       | Отслеживание изменений в файловой системе (watchdog) |

---

*Документ подготовлен для передачи аналитикам и планировщикам.*
